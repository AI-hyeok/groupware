<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TECH X - 비품 예약 상세</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        .container {
            width: 80%;
            max-width: 600px;
            margin: 2rem auto;
            background-color: white;
            padding: 2rem;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .selected-supplies {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .selected-supplies-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 1rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            margin-top: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>비품 예약 상세</h1>

    <div class="selected-supplies" id="selected-supplies-list">
        <!-- 선택된 비품들이 여기에 동적으로 추가됩니다 -->
    </div>

    <form id="booking-form">
        <div class="form-group">
            <label for="booking-date">예약 날짜</label>
            <input type="date" id="booking-date" required>
        </div>

        <div class="form-group">
            <label for="start-time">시작 시간</label>
            <input type="time" id="start-time" required>
        </div>

        <div class="form-group">
            <label for="end-time">종료 시간</label>
            <input type="time" id="end-time" required>
        </div>

        <div class="form-group">
            <label for="purpose">사용 목적</label>
            <textarea id="purpose" rows="4" placeholder="비품 사용 목적을 간단히 작성해주세요" required></textarea>
        </div>

        <button type="submit" class="btn" id="submit-booking">예약 신청</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Parse query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const selectedSupplies = [];

        // Collect selected supplies from URL
        urlParams.forEach((value, key) => {
            if (key.startsWith('supplyId')) {
                const quantityKey = key.replace('supplyId', 'quantity');
                const supplyId = value;
                const quantity = urlParams.get(quantityKey);

                if (supplyId && quantity) {
                    selectedSupplies.push({
                        id: supplyId,
                        quantity: parseInt(quantity)
                    });
                }
            }
        });

        // Populate selected supplies list
        const selectedSuppliesList = document.getElementById('selected-supplies-list');
        selectedSupplies.forEach(supply => {
            const supplyItem = document.createElement('div');
            supplyItem.classList.add('selected-supplies-item');
            supplyItem.innerHTML = `
                    <span>${supply.id}</span>
                    <span>수량: ${supply.quantity}개</span>
                `;
            selectedSuppliesList.appendChild(supplyItem);
        });

        // Set min date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('booking-date').setAttribute('min', today);

        // Form submission
        const bookingForm = document.getElementById('booking-form');
        bookingForm.addEventListener('submit', function(e) {
            e.preventDefault();

            // Collect form data
            const bookingData = {
                supplies: selectedSupplies,
                date: document.getElementById('booking-date').value,
                startTime: document.getElementById('start-time').value,
                endTime: document.getElementById('end-time').value,
                purpose: document.getElementById('purpose').value
            };

            // Validate times
            const startTime = new Date(`2023-01-01T${bookingData.startTime}`);
            const endTime = new Date(`2023-01-01T${bookingData.endTime}`);

            if (startTime >= endTime) {
                alert('종료 시간은 시작 시간보다 늦어야 합니다.');
                return;
            }

            // Submit booking
            fetch('/api/booking/supplies', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bookingData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('비품 예약이 완료되었습니다.');
                        // Redirect to booking confirmation or main page
                        window.location.href = '/booking/main';
                    } else {
                        alert('예약에 실패했습니다: ' + (data.message || '알 수 없는 오류'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('예약 중 오류가 발생했습니다.');
                });
        });
    });
</script>
</body>
</html>
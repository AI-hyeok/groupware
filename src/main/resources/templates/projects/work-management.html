<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>업무 관리</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Custom CSS -->
    <!--    <link rel="stylesheet" th:href="@{/assets/css/fragments/sidebar-common.css}">-->
    <link rel="stylesheet" th:href="@{/assets/css/projects/work-management.css}">
    <!-- 헤더 에셋 포함 -->
    <th:block th:replace="fragments/header :: headerAssets"></th:block>

    <style>
        body{
            margin-top: 80px;
        }
    </style>
</head>
<body>
<!-- 헤더 포함 -->
<div th:replace="fragments/header :: header"></div>

<div class="container-fluid">

    <div class="row">
        <div th:replace="fragments/sidebar/work-sidebar :: work-sidebar"></div>
        <!-- Main content -->
        <main class="col-md-10 px-md-4">
<!--            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">-->
<!--                <h1 class="h2">업무 관리</h1>-->
<!--                <div class="btn-toolbar mb-2 mb-md-0">-->
<!--                    <div class="btn-group me-2">-->
<!--                        <a th:href="@{/workmanagement}" class="btn btn-sm btn-outline-primary">업무</a>-->
<!--                        <a th:href="@{/workmanagement/register}" class="btn btn-sm btn-outline-secondary">등록</a>-->
<!--                        <a th:href="@{/workmanagement/schedule}" class="btn btn-sm btn-outline-info">일정</a>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->



            <!-- Tabs -->
            <ul class="nav nav-tabs" id="workTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="projects-tab" data-bs-toggle="tab" data-bs-target="#projects" type="button" role="tab" aria-controls="projects" aria-selected="true">
                        <i class="fas fa-project-diagram"></i> 프로젝트
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="my-tasks-tab" data-bs-toggle="tab" data-bs-target="#my-tasks" type="button" role="tab" aria-controls="my-tasks" aria-selected="false">
                        <i class="fas fa-tasks"></i> 내 업무
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="todo-tab" data-bs-toggle="tab" data-bs-target="#todo" type="button" role="tab" aria-controls="todo" aria-selected="false">
                        <i class="fas fa-clipboard-check"></i> To-Do
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="task-logs-tab" data-bs-toggle="tab" data-bs-target="#task-logs" type="button" role="tab" aria-controls="task-logs" aria-selected="false">
                        <i class="fas fa-history"></i> 업무 로그
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="workTabsContent">
                <!-- Projects Tab -->
                <div class="tab-pane fade show active" id="projects" role="tabpanel" aria-labelledby="projects-tab">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="input-group">
                                <input type="text" id="project-search" class="form-control" placeholder="프로젝트 검색...">
                                <button class="btn btn-outline-primary" type="button">검색</button>
                            </div>
                        </div>
                    </div>

                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="project-cards">
                        <!-- Project cards will be rendered here -->
                        <div class="col" th:each="project : ${projects}">
                            <div class="card project-card" th:data-project-id="${project.id}">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span th:text="${project.name}">프로젝트명</span>
                                    <span class="badge" th:classappend="${project.status == '진행중' ? 'bg-success' : project.status == '완료' ? 'bg-primary' : 'bg-warning'}" th:text="${project.status}">상태</span>
                                </div>
                                <div class="card-body">
                                    <p class="card-text" th:text="${project.description}">프로젝트 설명</p>
                                    <div class="progress task-progress">
                                        <div class="progress-bar" role="progressbar" th:style="'width: ' + ${project.progress} + '%'" th:attr="aria-valuenow=${project.progress}" aria-valuemin="0" aria-valuemax="100" th:text="${project.progress + '%'}">0%</div>
                                    </div>
                                    <small class="text-muted">
                                        <span th:text="${project.taskCount}">0</span>개 업무 중 <span th:text="${project.completedTaskCount}">0</span>개 완료
                                    </small>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted" th:text="${#temporals.format(project.startDate, 'yyyy-MM-dd')} + ' ~ ' + ${#temporals.format(project.endDate, 'yyyy-MM-dd')}">기간</small>
                                        <small class="text-muted">
                                            <span th:if="${not #lists.isEmpty(project.memberNames)}" th:text="${#strings.listJoin(project.memberNames, ', ')}">참여자</span>
                                            <span th:if="${#lists.isEmpty(project.memberNames)}">참여자 없음</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End of project cards -->
                    </div>
                </div>

                <!-- 프로젝트 상세 정보 모달 -->
                <div class="modal fade" id="projectDetailModal" tabindex="-1" aria-labelledby="projectDetailModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="projectDetailModalLabel">프로젝트 상세 정보</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div id="project-detail-container">
                                    <div class="text-center">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">로딩 중...</span>
                                        </div>
                                        <p>프로젝트 정보를 불러오는 중입니다...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 업무 등록 모달 -->
                <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="addTaskModalLabel">새 업무 등록</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="add-task-form">
                                    <input type="hidden" id="project-id-for-task" value="">

                                    <div class="mb-3">
                                        <label for="task-title" class="form-label">업무 제목</label>
                                        <input type="text" class="form-control" id="task-title" required>
                                    </div>

                                    <div class="mb-3">
                                        <label for="task-description" class="form-label">업무 설명</label>
                                        <textarea class="form-control" id="task-description" rows="3"></textarea>
                                    </div>

                                    <div class="mb-3">
                                        <label for="task-priority" class="form-label">우선순위</label>
                                        <select class="form-select" id="task-priority">
                                            <option value="낮음">낮음</option>
                                            <option value="중간" selected>중간</option>
                                            <option value="높음">높음</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="task-due-date" class="form-label">마감일</label>
                                        <input type="date" class="form-control" id="task-due-date">
                                    </div>

                                    <div class="mb-3">
                                        <label for="task-assignee" class="form-label">담당자</label>
                                        <select class="form-select" id="task-assignee">
                                            <option value="">담당자 선택</option>
                                            <!-- 다른 프로젝트 멤버들은 JavaScript로 동적 로드 -->
                                        </select>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                <button type="button" class="btn btn-primary" id="save-task-btn">저장</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- My Tasks Tab -->
                <div class="tab-pane fade" id="my-tasks" role="tabpanel" aria-labelledby="my-tasks-tab">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5>내 담당 업무</h5>
                                <div class="d-flex">
                                    <!-- 업무 필터 -->
                                    <select class="form-select form-select-sm me-2" id="my-task-filter">
                                        <option value="all">전체</option>
                                        <option value="incomplete">미완료</option>
                                        <option value="complete">완료</option>
                                        <option value="overdue">지연</option>
                                    </select>
                                    <!-- 업무 정렬 -->
                                    <select class="form-select form-select-sm me-2" id="my-task-sort">
                                        <option value="dueDate">마감일순</option>
                                        <option value="priority">우선순위순</option>
                                        <option value="project">프로젝트별</option>
                                    </select>
                                    <!-- 검색창 -->
                                    <input type="text" class="form-control form-control-sm" id="my-task-search"
                                           placeholder="업무 검색...">
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="my-tasks-container">
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">로딩 중...</span>
                                    </div>
                                    <p>내 업무를 불러오는 중입니다...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 업무 진행도 업데이트 모달 -->
                <div class="modal fade" id="taskProgressModal" tabindex="-1" aria-labelledby="taskProgressModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="task-progress-modal-title">업무 진행도 업데이트</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" id="task-id-for-progress">
                                <div class="mb-3">
                                    <label for="task-progress-slider" class="form-label">진행도: <span id="task-progress-value">0%</span></label>
                                    <input type="range" class="form-range" min="0" max="100" step="5" id="task-progress-slider">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                <button type="button" class="btn btn-primary" id="save-progress-btn">저장</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Todo Tab -->
                <div class="tab-pane fade" id="todo" role="tabpanel" aria-labelledby="todo-tab">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <button id="add-todo-btn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#todoModal">
                                <i class="fas fa-plus"></i> 새 할 일
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" id="todo-search" class="form-control" placeholder="할 일 검색...">
                                <button class="btn btn-outline-primary" type="button">검색</button>
                            </div>
                        </div>
                    </div>

                    <div class="list-group" id="todo-list">
                        <!-- Todo items will be rendered here -->
                        <div th:each="todo : ${todoList}" class="list-group-item list-group-item-action todo-list-item"
                             th:classappend="${todo.completed ? 'completed' : ''}"
                             th:data-todo-id="${todo.id}">
                            <div class="d-flex align-items-center">
                                <input class="form-check-input me-2 todo-checkbox" type="checkbox" th:checked="${todo.completed}">
                                <div class="flex-grow-1">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1" th:text="${todo.title}">할 일 제목</h5>
                                        <span class="badge" th:classappend="${todo.priority == '높음' ? 'bg-danger' : todo.priority == '중간' ? 'bg-warning' : 'bg-info'}" th:text="${todo.priority}">우선순위</span>
                                    </div>
                                    <p class="mb-1" th:text="${todo.content}">할 일 내용</p>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar-alt"></i>
                                        <span th:text="${#temporals.format(todo.dueDate, 'yyyy-MM-dd')}">마감일</span>
                                        <span th:if="${todo.isOverdue && !todo.completed}" class="text-danger"> (마감일 초과)</span>
                                        <span th:if="${!todo.isOverdue && !todo.completed}"> (남은 일수: <span th:text="${todo.remainingDays}">0</span>일)</span>
                                        <span th:if="${todo.completed}" class="text-success"> (완료됨)</span>
                                    </small>
                                </div>
                                <div class="ms-2">
                                    <button class="btn btn-sm btn-outline-primary edit-todo-btn" data-bs-toggle="modal" data-bs-target="#todoModal">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-todo-btn">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- End of todo items -->
                    </div>
                </div>

                <!-- Task Logs Tab -->
                <div class="tab-pane fade" id="task-logs" role="tabpanel" aria-labelledby="task-logs-tab">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="input-group">
                                <input type="text" id="log-search" class="form-control" placeholder="로그 검색...">
                                <button class="btn btn-outline-primary" type="button">검색</button>
                            </div>
                        </div>
                    </div>

                    <div id="task-logs-container">
                        <!-- Task logs will be loaded via AJAX -->
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">로딩 중...</span>
                            </div>
                            <p>업무 로그를 불러오는 중입니다...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Todo Modal -->
<div class="modal fade" id="todoModal" tabindex="-1" aria-labelledby="todoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="todoModalLabel">새 할 일</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="todoForm">
                    <input type="hidden" id="todo-id">
                    <div class="mb-3">
                        <label for="todo-title" class="form-label">제목</label>
                        <input type="text" class="form-control" id="todo-title" required>
                    </div>
                    <div class="mb-3">
                        <label for="todo-content" class="form-label">내용</label>
                        <textarea class="form-control" id="todo-content" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="todo-due-date" class="form-label">마감일</label>
                        <input type="date" class="form-control" id="todo-due-date" required>
                    </div>
                    <div class="mb-3">
                        <label for="todo-priority" class="form-label">우선순위</label>
                        <select class="form-select" id="todo-priority" required>
                            <option value="높음">높음</option>
                            <option value="중간" selected>중간</option>
                            <option value="낮음">낮음</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="save-todo-btn">저장</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap and jQuery JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">

    var currentUser = {
        empNum: null,
        name: null
    };


    // 전역 변수로 현재 사용자 ID 선언 (임시 해결책)
    var currentUserEmpNum = "";

    $(document).ready(function() {

        loadCurrentUserInfo();
        // 현재 페이지에 따라 사이드바 활성화
        highlightActiveSidebar();

        // Task logs Ajax loading
        loadTaskLogs();

        // 프로젝트 카드 클릭 이벤트
        initProjectCardEvents();

        // Todo checkbox click
        $(document).on('change', '.todo-checkbox', function(e) {
            e.stopPropagation();
            const todoId = $(this).closest('.todo-list-item').data('todo-id');
            toggleTodoCompletion(todoId);
        });

        // Todo item click (excluding checkbox)
        $(document).on('click', '.todo-list-item', function(e) {
            if (!$(e.target).hasClass('todo-checkbox') &&
                !$(e.target).hasClass('edit-todo-btn') &&
                !$(e.target).hasClass('delete-todo-btn') &&
                !$(e.target).hasClass('fa-edit') &&
                !$(e.target).hasClass('fa-trash')) {
                const todoId = $(this).data('todo-id');
                openTodoModal(todoId);
            }
        });

        // Edit todo button click
        $(document).on('click', '.edit-todo-btn', function(e) {
            e.stopPropagation();
            const todoId = $(this).closest('.todo-list-item').data('todo-id');
            openTodoModal(todoId);
        });

        // Delete todo button click
        $(document).on('click', '.delete-todo-btn', function(e) {
            e.stopPropagation();
            const todoId = $(this).closest('.todo-list-item').data('todo-id');
            if (confirm('정말로 이 할 일을 삭제하시겠습니까?')) {
                deleteTodo(todoId);
            }
        });

        // Save todo button click
        $('#save-todo-btn').on('click', function() {
            if (validateTodoForm()) {
                saveTodo();
            }
        });

        // Task filter change
        $('#task-filter').on('change', function() {
            const status = $(this).val();
            filterTasks(status);
        });

        // Task search
        $('#task-search').on('keyup', function() {
            const searchText = $(this).val().toLowerCase();
            searchTasks(searchText);
        });

        // Todo search
        $('#todo-search').on('keyup', function() {
            const searchText = $(this).val().toLowerCase();
            searchTodos(searchText);
        });

        // Project search
        $('#project-search').on('keyup', function() {
            const searchText = $(this).val().toLowerCase();
            searchProjects(searchText);
        });

        // Log search
        $('#log-search').on('keyup', function() {
            const searchText = $(this).val().toLowerCase();
            searchLogs(searchText);
        });

        // 업무 탭 클릭 이벤트
        $('#workTabs a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            if (e.target.id === 'task-logs-tab') {
                // 로그 탭이 활성화되면 최신 로그 로드
                loadTaskLogs();
            }
        });

        // 업무 항목 클릭 이벤트 - 진행도 모달 표시
        $(document).on('click', '.task-list-item', function() {
            const taskId = $(this).data('task-id');
            const currentProgress = parseInt($(this).find('.progress-bar').attr('aria-valuenow'));
            const taskTitle = $(this).find('h5').text();

            // 업무 진행도 업데이트 모달 준비
            $('#task-progress-modal-title').text(`${taskTitle} - 진행도 업데이트`);
            $('#task-progress-slider').val(currentProgress);
            $('#task-progress-value').text(`${currentProgress}%`);
            $('#task-id-for-progress').val(taskId);

            // 진행도 모달 표시
            $('#taskProgressModal').modal('show');
        });

        // 진행도 슬라이더 값 변경 시 실시간 업데이트
        $('#task-progress-slider').on('input', function() {
            const progressValue = $(this).val();
            $('#task-progress-value').text(`${progressValue}%`);
        });

        // 진행도 저장 버튼 클릭
        $('#save-progress-btn').on('click', function() {
            const taskId = $('#task-id-for-progress').val();
            const progress = parseInt($('#task-progress-slider').val());

            // 진행도 업데이트 API 호출
            updateTaskProgress(taskId, progress);
        });

        // 프로젝트 탭이 활성화될 때 프로젝트 정보 새로고침
        $('#workTabs button[data-bs-target="#projects"]').on('shown.bs.tab', function() {
            refreshUserProjects()
        });

        // 내 업무 탭이 활성화될 때 업무 목록 불러오기
        $('#workTabs button[data-bs-target="#my-tasks"]').on('shown.bs.tab', function() {
            loadMyTasks();
        });

        // 내 업무 필터 변경 시 이벤트
        $('#my-task-filter').on('change', function() {
            filterMyTasks();
        });

        // 내 업무 정렬 변경 시 이벤트
        $('#my-task-sort').on('change', function() {
            sortMyTasks();
        });

        // 내 업무 검색 시 이벤트
        $('#my-task-search').on('keyup', function() {
            const searchText = $(this).val().toLowerCase();
            searchMyTasks(searchText);
        });

    });

    // 현재 사용자 정보 가져오기
    function loadCurrentUserInfo() {
        $.ajax({
            url: '/api/auth/current-user',
            method: 'GET',
            success: function(user) {
                currentUser.empNum = user.empNum;
                console.log("현재 사용자 정보 로드 완료:", currentUser);
            },
            error: function(xhr, status, error) {
                console.error("사용자 정보 로드 실패:", error);
            }
        });
    }

    // 사용자 프로젝트 새로고침 함수
    function refreshUserProjects() {
        $.ajax({
            url: '/api/projects/my-projects', // 사용자 프로젝트만 가져오는 API
            method: 'GET',
            success: function(projects) {
                renderProjects(projects);
            },
            error: function(xhr, status, error) {
                console.error('프로젝트 로드 오류:', error);
                alert('프로젝트 정보를 불러오는데 실패했습니다.');
            }
        });
    }

    // 현재 페이지 URL에 따라 사이드바 메뉴 활성화
    function highlightActiveSidebar() {
        const currentPath = window.location.pathname;
        $('.work-sidebar .nav-link').removeClass('active');

        if (currentPath.endsWith('/register')) {
            $('.work-sidebar .nav-link[href$="/register"]').addClass('active');
        } else if (currentPath.endsWith('/schedule')) {
            $('.work-sidebar .nav-link[href$="/schedule"]').addClass('active');
        } else {
            $('.work-sidebar .nav-link[href$="/workmanagement"]').addClass('active');
        }
    }

    function loadTaskLogs() {
        $.ajax({
            url: '/api/tasks/logs/recent',
            method: 'GET',
            data: { limit: 20 }, // 최근 20개 로그만 가져오기
            success: function(response) {
                renderTaskLogs(response);
            },
            error: function(xhr, status, error) {
                console.error('로그 로드 오류:', xhr, status, error);
                $('#task-logs-container').html('<div class="alert alert-danger">업무 로그를 불러오는데 실패했습니다.</div>');
            }
        });
    }

    // 내 업무 목록 불러오기
    function loadMyTasks() {
        $('#my-tasks-container').html(`
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">로딩 중...</span>
            </div>
            <p>내 업무를 불러오는 중입니다...</p>
        </div>
    `);

        $.ajax({
            url: '/api/tasks/my-tasks',
            method: 'GET',
            success: function(tasks) {
                // 전역 변수에 업무 목록 저장 (필터링용)
                window.myTasks = tasks;
                renderMyTasks(tasks);
            },
            error: function(xhr, status, error) {
                $('#my-tasks-container').html(`
                <div class="alert alert-danger">
                    <p>업무 목록을 불러오는데 실패했습니다.</p>
                    <p>오류: ${error}</p>
                </div>
            `);
            }
        });
    }
    // 내 업무 목록 렌더링
    function renderMyTasks(tasks) {
        if (!tasks || tasks.length === 0) {
            $('#my-tasks-container').html('<p class="text-center">담당하는 업무가 없습니다.</p>');
            return;
        }

        let html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>프로젝트</th>
                        <th>업무</th>
                        <th>상태</th>
                        <th>우선순위</th>
                        <th>진행률</th>
                        <th>마감일</th>
                    </tr>
                </thead>
                <tbody>
    `;

        tasks.forEach(task => {
            // 상태에 따른 뱃지 클래스
            let statusClass = '';
            if (task.status === '미시작') {
                statusClass = 'bg-secondary';
            } else if (task.status === '진행중') {
                statusClass = 'bg-primary';
            } else if (task.status === '완료') {
                statusClass = 'bg-success';
            } else {
                statusClass = 'bg-warning';
            }

            // 우선순위에 따른 뱃지 클래스
            let priorityClass = '';
            if (task.priority === '높음') {
                priorityClass = 'bg-danger';
            } else if (task.priority === '중간') {
                priorityClass = 'bg-warning';
            } else {
                priorityClass = 'bg-info';
            }

            // 마감일 처리
            let dueDateDisplay = task.dueDate ? formatDate(new Date(task.dueDate)) : '미정';
            let dueDateClass = '';

            // 마감일이 지난 경우 빨간색으로 표시
            if (task.dueDate && new Date(task.dueDate) < new Date() && task.status !== '완료') {
                dueDateClass = 'text-danger fw-bold';
            }

            html += `
            <tr class="task-list-item" data-task-id="${task.id}">
                <td>${task.projectName || '-'}</td>
                <td>${task.title}</td>
                <td><span class="badge ${statusClass}">${task.status}</span></td>
                <td><span class="badge ${priorityClass}">${task.priority}</span></td>
                <td>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: ${task.progress}%"
                            aria-valuenow="${task.progress}" aria-valuemin="0" aria-valuemax="100">
                            ${task.progress}%
                        </div>
                    </div>
                </td>
                <td class="${dueDateClass}">${dueDateDisplay}</td>
            </tr>
        `;
        });

        html += `
                </tbody>
            </table>
        </div>
    `;

        $('#my-tasks-container').html(html);

        // 업무 행 클릭 이벤트 등록
        $('.task-list-item').on('click', function() {
            const taskId = $(this).data('task-id');
            openTaskDetailModal(taskId);
        });
    }


    // 내 업무 필터링
    function filterMyTasks() {
        const filterValue = $('#my-task-filter').val();

        if (!window.myTasks) return;

        let filteredTasks = [...window.myTasks];

        // 필터 적용
        if (filterValue === 'incomplete') {
            filteredTasks = filteredTasks.filter(task => task.status !== '완료');
        } else if (filterValue === 'complete') {
            filteredTasks = filteredTasks.filter(task => task.status === '완료');
        } else if (filterValue === 'overdue') {
            const today = new Date();
            filteredTasks = filteredTasks.filter(task =>
                task.dueDate && new Date(task.dueDate) < today && task.status !== '완료'
            );
        }

        // 정렬 적용 (현재 선택된 정렬 기준)
        sortTasksByCurrentCriteria(filteredTasks);

        // 렌더링
        renderMyTasks(filteredTasks);
    }

    // 내 업무 정렬
    function sortMyTasks() {
        const sortValue = $('#my-task-sort').val();

        if (!window.myTasks) return;

        // 현재 필터 적용된 작업 목록 가져오기
        const filterValue = $('#my-task-filter').val();
        let tasksToSort = [...window.myTasks];

        // 필터 적용
        if (filterValue === 'incomplete') {
            tasksToSort = tasksToSort.filter(task => task.status !== '완료');
        } else if (filterValue === 'complete') {
            tasksToSort = tasksToSort.filter(task => task.status === '완료');
        } else if (filterValue === 'overdue') {
            const today = new Date();
            tasksToSort = tasksToSort.filter(task =>
                task.dueDate && new Date(task.dueDate) < today && task.status !== '완료'
            );
        }

        // 정렬 적용
        if (sortValue === 'dueDate') {
            tasksToSort.sort((a, b) => {
                if (!a.dueDate) return 1;
                if (!b.dueDate) return -1;
                return new Date(a.dueDate) - new Date(b.dueDate);
            });
        } else if (sortValue === 'priority') {
            const priorityOrder = { '높음': 1, '중간': 2, '낮음': 3 };
            tasksToSort.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
        } else if (sortValue === 'project') {
            tasksToSort.sort((a, b) => {
                if (!a.projectName) return 1;
                if (!b.projectName) return -1;
                return a.projectName.localeCompare(b.projectName);
            });
        }

        // 렌더링
        renderMyTasks(tasksToSort);
    }

    // 현재 선택된 기준으로 작업 정렬
    function sortTasksByCurrentCriteria(tasks) {
        const sortValue = $('#my-task-sort').val();

        if (sortValue === 'dueDate') {
            tasks.sort((a, b) => {
                if (!a.dueDate) return 1;
                if (!b.dueDate) return -1;
                return new Date(a.dueDate) - new Date(b.dueDate);
            });
        } else if (sortValue === 'priority') {
            const priorityOrder = { '높음': 1, '중간': 2, '낮음': 3 };
            tasks.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
        } else if (sortValue === 'project') {
            tasks.sort((a, b) => {
                if (!a.projectName) return 1;
                if (!b.projectName) return -1;
                return a.projectName.localeCompare(b.projectName);
            });
        }

        return tasks;
    }

    // 내 업무 검색
    function searchMyTasks(searchText) {
        if (!window.myTasks) return;

        if (!searchText) {
            // 검색어가 없으면 필터와 정렬만 적용
            filterMyTasks();
            return;
        }

        // 검색어로 필터링
        let searchedTasks = window.myTasks.filter(task =>
            task.title.toLowerCase().includes(searchText) ||
            (task.description && task.description.toLowerCase().includes(searchText)) ||
            (task.projectName && task.projectName.toLowerCase().includes(searchText))
        );

        // 현재 필터 적용
        const filterValue = $('#my-task-filter').val();
        if (filterValue === 'incomplete') {
            searchedTasks = searchedTasks.filter(task => task.status !== '완료');
        } else if (filterValue === 'complete') {
            searchedTasks = searchedTasks.filter(task => task.status === '완료');
        } else if (filterValue === 'overdue') {
            const today = new Date();
            searchedTasks = searchedTasks.filter(task =>
                task.dueDate && new Date(task.dueDate) < today && task.status !== '완료'
            );
        }

        // 정렬 적용
        sortTasksByCurrentCriteria(searchedTasks);

        // 렌더링
        renderMyTasks(searchedTasks);
    }


    // Render task logs
    function renderTaskLogs(logs) {
        // 데이터가 없거나 잘못된 형식인 경우 처리
        if (!logs || (Array.isArray(logs) && logs.length === 0)) {
            $('#task-logs-container').html('<div class="alert alert-info">최근 업무 로그가 없습니다.</div>');
            return;
        }

        // 로그가 배열이 아닌 경우 처리 (객체의 특정 속성에 배열이 있을 수 있음)
        let logsArray = logs;
        if (!Array.isArray(logs)) {
            // 객체 내부에 data 또는 content 등의 속성이 있는지 확인
            if (logs.data && Array.isArray(logs.data)) {
                logsArray = logs.data;
            } else if (logs.content && Array.isArray(logs.content)) {
                logsArray = logs.content;
            } else if (logs.items && Array.isArray(logs.items)) {
                logsArray = logs.items;
            } else if (logs.logs && Array.isArray(logs.logs)) {
                logsArray = logs.logs;
            } else {
                // 적절한 배열을 찾을 수 없는 경우
                $('#task-logs-container').html('<div class="alert alert-warning">로그 데이터 형식이 올바르지 않습니다.</div>');
                return;
            }
        }

        // 배열이 비어있는 경우
        if (logsArray.length === 0) {
            $('#task-logs-container').html('<div class="alert alert-info">최근 업무 로그가 없습니다.</div>');
            return;
        }

        let html = '';
        logsArray.forEach(log => {
            // 로그 타입에 따른 아이콘과 색상
            let iconClass = 'fas fa-info-circle text-info';
            if (log.logType === '업무 생성') {
                iconClass = 'fas fa-plus-circle text-success';
            } else if (log.logType === '업무 수정') {
                iconClass = 'fas fa-edit text-primary';
            } else if (log.logType === '상태 변경') {
                iconClass = 'fas fa-exchange-alt text-warning';
            } else if (log.logType === '진행률 변경') {
                iconClass = 'fas fa-chart-line text-primary';
            } else if (log.logType === '하위 업무 추가') {
                iconClass = 'fas fa-tasks text-success';
            } else if (log.logType === '하위 업무 완료') {
                iconClass = 'fas fa-check-circle text-success';
            }

            html += `
        <div class="task-log-item card mb-2">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="${iconClass} me-2"></i>
                        <strong>${log.empName || '사용자'}</strong>
                        <span class="badge bg-secondary ms-2">${log.logType || '업데이트'}</span>
                    </div>
                    <small class="text-muted">${log.createdAt ? formatDateTime(new Date(log.createdAt)) : '날짜 정보 없음'}</small>
                </div>
                <div class="mt-2">
                    <p class="mb-1">
                        <strong>${log.taskTitle || '업무'}</strong>
                        ${log.projectName ? `<span class="text-muted">[${log.projectName}]</span>` : ''}
                    </p>
                    ${log.oldValue ?
                `<p class="mb-0 small"><span class="text-muted">${log.oldValue}</span> → <span class="text-primary">${log.newValue || ''}</span></p>` :
                (log.newValue ? `<p class="mb-0 small"><span class="text-primary">${log.newValue}</span></p>` : '')
            }
                    ${log.comment ? `<p class="text-muted small mt-1">${log.comment}</p>` : ''}
                </div>
            </div>
        </div>
    `;
        });

        $('#task-logs-container').html(html);
    }

    // Open todo modal for editing or creating
    function openTodoModal(todoId) {
        // Reset form
        $('#todoForm')[0].reset();
        $('#todo-id').val('');
        $('#todoModalLabel').text('새 할 일');

        // If todoId is provided, load todo data
        if (todoId) {
            $('#todoModalLabel').text('할 일 수정');

            $.ajax({
                url: `/api/todos/${todoId}`,
                method: 'GET',
                success: function(todo) {
                    $('#todo-id').val(todo.id);
                    $('#todo-title').val(todo.title);
                    $('#todo-content').val(todo.content);
                    $('#todo-due-date').val(formatDate(new Date(todo.dueDate)));
                    $('#todo-priority').val(todo.priority);
                },
                error: function(xhr, status, error) {
                    console.error('할 일 데이터 로드 오류:', error);
                    alert('할 일 정보를 불러오는데 실패했습니다.');
                }
            });
        } else {
            // Set default due date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            $('#todo-due-date').val(formatDate(tomorrow));
        }

        $('#todoModal').modal('show');
    }

    // Todo 토글 기능
    function toggleTodoCompletion(todoId) {
        $.ajax({
            url: `/api/todos/${todoId}/toggle`,
            method: 'PATCH',
            success: function(todo) {
                const todoItem = $(`.todo-list-item[data-todo-id="${todoId}"]`);
                if (todo.completed) {
                    todoItem.addClass('completed');
                    todoItem.find('.todo-checkbox').prop('checked', true);
                    todoItem.find('h5, p').css('text-decoration', 'line-through');

                    // 완료 상태 표시
                    let statusText = todoItem.find('small:contains("마감일")');
                    statusText.html(`<i class="fas fa-calendar-alt"></i> ${formatDate(new Date(todo.dueDate))} <span class="text-success">(완료됨)</span>`);
                } else {
                    todoItem.removeClass('completed');
                    todoItem.find('.todo-checkbox').prop('checked', false);
                    todoItem.find('h5, p').css('text-decoration', 'none');

                    // 남은 일수 또는 마감일 초과 표시
                    let statusText = todoItem.find('small:contains("마감일")');
                    const dueDate = new Date(todo.dueDate);
                    const today = new Date();
                    const isOverdue = dueDate < today;

                    if (isOverdue) {
                        statusText.html(`<i class="fas fa-calendar-alt"></i> ${formatDate(dueDate)} <span class="text-danger">(마감일 초과)</span>`);
                    } else {
                        const daysLeft = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                        statusText.html(`<i class="fas fa-calendar-alt"></i> ${formatDate(dueDate)} (남은 일수: ${daysLeft}일)`);
                    }
                }
            },
            error: function(xhr, status, error) {
                alert('할 일 상태 변경에 실패했습니다: ' + error);
            }
        });
    }

    // 새로운 Todo 아이템 생성 시 유효성 검사
    function validateTodoForm() {
        const title = $('#todo-title').val().trim();
        const dueDate = $('#todo-due-date').val();

        if (!title) {
            alert('제목을 입력해주세요.');
            $('#todo-title').focus();
            return false;
        }

        if (!dueDate) {
            alert('마감일을 선택해주세요.');
            $('#todo-due-date').focus();
            return false;
        }

        return true;
    }

    // Todo 저장 기능
    function saveTodo() {
        const todoId = $('#todo-id').val();
        const todoData = {
            title: $('#todo-title').val(),
            content: $('#todo-content').val(),
            dueDate: $('#todo-due-date').val(),
            priority: $('#todo-priority').val()
        };

        const method = todoId ? 'PUT' : 'POST';
        const url = todoId ? `/api/todos/${todoId}` : '/api/todos';

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(todoData),
            success: function(todo) {
                $('#todoModal').modal('hide');

                // 새 할 일인 경우 목록에 추가
                if (!todoId) {
                    addTodoToList(todo);
                } else {
                    // 기존 할 일인 경우 목록 업데이트
                    updateTodoInList(todo);
                }
            },
            error: function(xhr, status, error) {
                alert('할 일 저장에 실패했습니다: ' + error);
            }
        });
    }

    // 업무 진행도 업데이트 후 프로젝트 정보 새로고침
    function updateTaskProgress(taskId, progress) {
        $.ajax({
            url: `/api/tasks/${taskId}/progress`,
            method: 'PATCH',
            contentType: 'application/json',
            data: JSON.stringify({ progress: progress }),
            success: function(updatedTask) {
                // 모달 닫기
                $('#taskProgressModal').modal('hide');

                // 업무 목록 UI 업데이트
                const taskItem = $(`.task-list-item[data-task-id="${taskId}"]`);
                taskItem.find('.progress-bar').css('width', `${progress}%`)
                    .attr('aria-valuenow', progress)
                    .text(`${progress}%`);

                // 상태 변경 (진행도에 따라)
                let newStatusClass = '';
                let newStatusText = '';

                if (progress === 0) {
                    newStatusClass = 'bg-secondary';
                    newStatusText = '미시작';
                } else if (progress === 100) {
                    newStatusClass = 'bg-success';
                    newStatusText = '완료';
                } else {
                    newStatusClass = 'bg-primary';
                    newStatusText = '진행중';
                }

                taskItem.find('.badge')
                    .removeClass('bg-secondary bg-primary bg-success')
                    .addClass(newStatusClass)
                    .text(newStatusText);

                // 관련 프로젝트 정보 새로고침
                if (updatedTask.projectId) {
                    refreshProjectInfo(updatedTask.projectId);
                }

                // 알림 표시
                alert('진행도가 업데이트되었습니다.');
            },
            error: function(xhr, status, error) {
                console.error("진행률 업데이트 오류:", xhr.responseText);
                alert('진행도 업데이트에 실패했습니다: ' + error);
            }
        });
    }

    // 특정 프로젝트 정보 새로고침
    function refreshProjectInfo(projectId) {
        $.ajax({
            url: `/api/projects/${projectId}`,
            method: 'GET',
            success: function(project) {
                // 프로젝트 카드 업데이트
                updateProjectCard(project);

                // 프로젝트 상세 모달이 열려있는 경우 내용 업데이트
                if ($('#projectDetailModal').hasClass('show') &&
                    $('#project-detail-container').find(`[data-project-id="${projectId}"]`).length > 0) {
                    renderProjectDetail(project);
                }
            },
            error: function(xhr, status, error) {
                console.error('프로젝트 정보 새로고침 오류:', error);
            }
        });
    }

    // 프로젝트 상세 페이지에 상태 변경 UI 추가
    function addStatusChangeButtons(project) {
        // 현재 완료된 프로젝트는 상태 변경 불가
        if (project.status === '완료') {
            return '';
        }

        return `
    <div class="mt-3">
        <div class="btn-group w-100">
            <button class="btn btn-sm btn-outline-secondary change-status-btn" data-status="준비중">준비중</button>
            <button class="btn btn-sm btn-outline-primary change-status-btn" data-status="진행중">진행중</button>
            <button class="btn btn-sm btn-outline-success change-status-btn" data-status="완료">완료</button>
        </div>
    </div>
    `;
    }

    // Delete todo
    function deleteTodo(todoId) {
        $.ajax({
            url: `/api/todos/${todoId}`,
            method: 'DELETE',
            success: function() {
                $(`.todo-list-item[data-todo-id="${todoId}"]`).remove();
            },
            error: function(xhr, status, error) {
                alert('할 일 삭제에 실패했습니다.');
            }
        });
    }

    // 프로젝트 카드 이벤트 초기화
    function initProjectCardEvents() {
        // 프로젝트 카드 클릭 이벤트
        $('.project-card').off('click').on('click', function() {
            const projectId = $(this).data('project-id');
            openProjectModal(projectId);
        });
    }

    // 프로젝트 모달 열기
    function openProjectModal(projectId) {
        // 모달 내용 초기화
        $('#project-detail-container').html(`
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">로딩 중...</span>
            </div>
            <p>프로젝트 정보를 불러오는 중입니다...</p>
        </div>
    `);

        // 모달 표시
        $('#projectDetailModal').modal('show');

        // 프로젝트 정보 가져오기
        $.ajax({
            url: `/api/projects/${projectId}`,
            method: 'GET',
            success: function(project) {
                renderProjectDetail(project);
            },
            error: function(xhr, status, error) {
                $('#project-detail-container').html(`
                <div class="alert alert-danger">
                    <p>프로젝트 정보를 불러오는데 실패했습니다.</p>
                    <p>오류: ${error}</p>
                </div>
            `);
            }
        });
    }

    // Filter tasks by status
    function filterTasks(status) {
        if (status === 'all') {
            $('.task-list-item').show();
        } else {
            $('.task-list-item').hide();
            $(`.task-list-item .badge:contains("${status}")`).closest('.task-list-item').show();
        }
    }

    // Search tasks
    function searchTasks(searchText) {
        $('.task-list-item').each(function() {
            const title = $(this).find('h5').text().toLowerCase();
            const description = $(this).find('p').text().toLowerCase();
            const projectName = $(this).find('small:contains("프로젝트명")').text().toLowerCase();

            if (title.includes(searchText) || description.includes(searchText) || projectName.includes(searchText)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    }

    // Search todos
    function searchTodos(searchText) {
        $('.todo-list-item').each(function() {
            const title = $(this).find('h5').text().toLowerCase();
            const content = $(this).find('p').text().toLowerCase();

            if (title.includes(searchText) || content.includes(searchText)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    }

    // Search projects
    function searchProjects(searchText) {
        $('.project-card').each(function() {
            const name = $(this).find('.card-header span:first-child').text().toLowerCase();
            const description = $(this).find('.card-text').text().toLowerCase();
            const members = $(this).find('small:contains("참여자")').text().toLowerCase();

            if (name.includes(searchText) || description.includes(searchText) || members.includes(searchText)) {
                $(this).closest('.col').show();
            } else {
                $(this).closest('.col').hide();
            }
        });
    }

    // 로그 검색 기능
    function searchLogs(searchText) {
        $('.task-log-item').each(function() {
            const text = $(this).text().toLowerCase();

            if (text.includes(searchText.toLowerCase())) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    }

    // 프로젝트별 업무 로그 필터링
    function loadProjectTaskLogs(projectId) {
        $.ajax({
            url: `/api/tasks/logs/project/${projectId}`,
            method: 'GET',
            data: { limit: 50 }, // 최대 50개 로그 가져오기
            success: function(logs) {
                renderTaskLogs(logs);
                $('#task-logs-tab').tab('show'); // 로그 탭으로 자동 전환
            },
            error: function(xhr, status, error) {
                console.error('프로젝트 로그 로드 오류:', xhr, status, error);
                $('#task-logs-container').html('<div class="alert alert-danger">프로젝트 업무 로그를 불러오는데 실패했습니다.</div>');
            }
        });
    }

    // Format date (yyyy-MM-dd)
    function formatDate(date) {
        if (!(date instanceof Date) || isNaN(date)) {
            return '날짜 없음';
        }

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');

        return `${year}-${month}-${day}`;
    }

    // Format date and time (yyyy-MM-dd HH:mm)
    function formatDateTime(date) {
        if (!(date instanceof Date) || isNaN(date)) {
            return '날짜 정보 없음';
        }

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');

        return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    // 기존 할 일 항목 업데이트
    function updateTodoInList(todo) {
        const todoItem = $(`.todo-list-item[data-todo-id="${todo.id}"]`);
        const dueDate = new Date(todo.dueDate);
        const today = new Date();
        const isOverdue = dueDate < today && !todo.completed;
        const daysLeft = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

        let priorityClass = '';
        if (todo.priority === '높음') {
            priorityClass = 'bg-danger';
        } else if (todo.priority === '중간') {
            priorityClass = 'bg-warning';
        } else {
            priorityClass = 'bg-info';
        }

        // 항목 내용 업데이트
        todoItem.find('h5').text(todo.title).css('text-decoration', todo.completed ? 'line-through' : 'none');
        todoItem.find('p').text(todo.content || '').css('text-decoration', todo.completed ? 'line-through' : 'none');
        todoItem.find('.badge').removeClass('bg-danger bg-warning bg-info').addClass(priorityClass).text(todo.priority);

        // 날짜 정보 업데이트
        let dateInfo = `<i class="fas fa-calendar-alt"></i> ${formatDate(dueDate)}`;
        if (todo.completed) {
            dateInfo += ' <span class="text-success">(완료됨)</span>';
        } else if (isOverdue) {
            dateInfo += ' <span class="text-danger">(마감일 초과)</span>';
        } else {
            dateInfo += ` (남은 일수: ${daysLeft}일)`;
        }
        todoItem.find('small').html(dateInfo);
    }

    // 새 할 일을 목록에 추가
    function addTodoToList(todo) {
        const dueDate = new Date(todo.dueDate);
        const today = new Date();
        const isOverdue = dueDate < today && !todo.completed;
        const daysLeft = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

        let priorityClass = '';
        if (todo.priority === '높음') {
            priorityClass = 'bg-danger';
        } else if (todo.priority === '중간') {
            priorityClass = 'bg-warning';
        } else {
            priorityClass = 'bg-info';
        }

        const html = `
        <div class="list-group-item list-group-item-action todo-list-item ${todo.completed ? 'completed' : ''}"
             data-todo-id="${todo.id}">
            <div class="d-flex align-items-center">
                <input class="form-check-input me-2 todo-checkbox" type="checkbox" ${todo.completed ? 'checked' : ''}>
                <div class="flex-grow-1">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1" style="${todo.completed ? 'text-decoration: line-through' : ''}">${todo.title}</h5>
                        <span class="badge ${priorityClass}">${todo.priority}</span>
                    </div>
                    <p class="mb-1" style="${todo.completed ? 'text-decoration: line-through' : ''}">${todo.content || ''}</p>
                    <small class="text-muted">
                        <i class="fas fa-calendar-alt"></i>
                        ${formatDate(dueDate)}
                        ${todo.completed ?
            '<span class="text-success">(완료됨)</span>' :
            (isOverdue ?
                '<span class="text-danger">(마감일 초과)</span>' :
                `(남은 일수: ${daysLeft}일)`)
        }
                    </small>
                </div>
                <div class="ms-2">
                    <button class="btn btn-sm btn-outline-primary edit-todo-btn">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-todo-btn">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;

        $('#todo-list').prepend(html);

        // 새로 추가된 항목에 이벤트 핸들러 등록
        initTodoEvents();
    }

    // Todo 이벤트 초기화
    function initTodoEvents() {
        // 체크박스 클릭 이벤트
        $('.todo-checkbox').off('change').on('change', function(e) {
            e.stopPropagation();
            const todoId = $(this).closest('.todo-list-item').data('todo-id');
            toggleTodoCompletion(todoId);
        });

        // 할 일 항목 클릭 이벤트 (체크박스, 편집, 삭제 버튼 제외)
        $('.todo-list-item').off('click').on('click', function(e) {
            if (!$(e.target).hasClass('todo-checkbox') &&
                !$(e.target).hasClass('edit-todo-btn') &&
                !$(e.target).hasClass('delete-todo-btn') &&
                !$(e.target).hasClass('fa-edit') &&
                !$(e.target).hasClass('fa-trash')) {
                const todoId = $(this).data('todo-id');
                openTodoModal(todoId);
            }
        });

        // 편집 버튼 클릭 이벤트
        $('.edit-todo-btn').off('click').on('click', function(e) {
            e.stopPropagation();
            const todoId = $(this).closest('.todo-list-item').data('todo-id');
            openTodoModal(todoId);
        });

        // 삭제 버튼 클릭 이벤트
        $('.delete-todo-btn').off('click').on('click', function(e) {
            e.stopPropagation();
            const todoId = $(this).closest('.todo-list-item').data('todo-id');
            if (confirm('정말로 이 할 일을 삭제하시겠습니까?')) {
                deleteTodo(todoId);
            }
        });
    }

    // 프로젝트 상세 정보 렌더링 함수
    function renderProjectDetail(project) {
        // 프로젝트 진행률 상태에 따른 클래스
        let progressClass = '';
        if (project.progress < 30) {
            progressClass = 'bg-danger';
        } else if (project.progress < 70) {
            progressClass = 'bg-warning';
        } else {
            progressClass = 'bg-success';
        }

        // 프로젝트 상태에 따른 뱃지 클래스
        let statusClass = '';
        if (project.status === '진행중') {
            statusClass = 'bg-primary';
        } else if (project.status === '완료') {
            statusClass = 'bg-success';
        } else if (project.status === '지연') {
            statusClass = 'bg-danger';
        } else if (project.status === '준비중') {
            statusClass = 'bg-secondary';
        } else {
            statusClass = 'bg-warning';
        }

        // 날짜 포맷팅
        const startDate = project.startDate ? formatDate(new Date(project.startDate)) : '미정';
        const endDate = project.endDate ? formatDate(new Date(project.endDate)) : '미정';
        const actualEndDate = project.actualEndDate ? formatDate(new Date(project.actualEndDate)) : '-';

        // 프로젝트 상세 정보 HTML 생성
        let html = `
<div class="project-detail">
    <div class="row mb-4">
        <div class="col-md-8">
            <h3>${project.name} <span class="badge ${statusClass}">${project.status}</span></h3>
            <p class="text-muted">
                <strong>계획 기간:</strong> ${startDate} ~ ${endDate}<br>
                <strong>실제 완료일:</strong> ${actualEndDate}
            </p>
        </div>
        <div class="col-md-4 text-end">
            <p>진행률</p>
            <div class="progress">
                <div class="progress-bar ${progressClass}" role="progressbar" style="width: ${project.progress}%"
                    aria-valuenow="${project.progress}" aria-valuemin="0" aria-valuemax="100">
                    ${project.progress}%
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>프로젝트 설명</h5>
                </div>
                <div class="card-body">
                    <p>${project.description || '프로젝트 설명이 없습니다.'}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>참여자</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                    ${project.memberNames && project.memberNames.length > 0 ?
            project.memberNames.map(member => `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ${member}
                                <span class="badge bg-primary rounded-pill">참여자</span>
                            </li>
                        `).join('') :
            '<li class="list-group-item">참여자가 없습니다.</li>'
        }
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5>진행 상황</h5>
                </div>
                <div class="card-body">
                    <p><strong>전체 업무:</strong> ${project.taskCount || 0}개</p>
                    <p><strong>완료된 업무:</strong> ${project.completedTaskCount || 0}개</p>
                    <p><strong>남은 업무:</strong> ${(project.taskCount || 0) - (project.completedTaskCount || 0)}개</p>

                    <div class="progress mt-3">
                        <div class="progress-bar ${progressClass}" role="progressbar" style="width: ${project.progress}%"
                            aria-valuenow="${project.progress}" aria-valuemin="0" aria-valuemax="100">
                            ${project.progress}%
                        </div>
                    </div>

                    <!-- 프로젝트 상태 변경 버튼 (완료 상태가 아닌 경우만 표시) -->
                    ${project.status !== '완료' ? `
                    <div class="mt-3">
                        <div class="btn-group w-100">
                            <button class="btn btn-sm btn-outline-secondary change-status-btn" data-status="준비중">준비중</button>
                            <button class="btn btn-sm btn-outline-primary change-status-btn" data-status="진행중">진행중</button>
                            <button class="btn btn-sm btn-outline-success change-status-btn" data-status="완료">완료</button>
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>업무 목록</h5>
                    <div>
                    <button class="btn btn-sm btn-success" id="add-task-btn" data-project-id="${project.id}">
                          <i class="fas fa-plus"></i> 새 업무 추가
                    </button>
                        <button class="btn btn-sm btn-primary" id="load-tasks-btn" data-project-id="${project.id}">
                            업무 불러오기
                        </button>
                        <button class="btn btn-sm btn-info" id="load-logs-btn" data-project-id="${project.id}">
                            로그 보기
                        </button>
                        ${project.status !== '완료' ? `
                        <button class="btn btn-sm btn-success" id="complete-project-btn" data-project-id="${project.id}">
                            프로젝트 완료
                        </button>` : ''}
                    </div>
                </div>
                <div class="card-body">
                    <div id="project-tasks-container">
                        <p class="text-center">업무 목록을 불러오려면 버튼을 클릭하세요.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
`;



        // HTML 삽입
        $('#project-detail-container').html(html);

        // 업무 불러오기 버튼 이벤트 등록
        $('#load-tasks-btn').off('click').on('click', function() {
            const projectId = $(this).data('project-id');
            loadProjectTasks(projectId);
        });

        // 로그 보기 버튼 이벤트 등록
        $('#load-logs-btn').off('click').on('click', function() {
            const projectId = $(this).data('project-id');
            loadProjectTaskLogs(projectId);
            $('#projectDetailModal').modal('hide'); // 프로젝트 모달 닫기
        });

        // 프로젝트 완료 버튼 이벤트
        $('#complete-project-btn').off('click').on('click', function() {
            const projectId = $(this).data('project-id');
            if (confirm('프로젝트를 완료 처리하시겠습니까?')) {
                completeProject(projectId);
            }
        });

        // 상태 변경 버튼 이벤트 - 특정 프로젝트 ID를 직접 사용
        $('.change-status-btn').off('click').on('click', function() {
            const status = $(this).data('status');
            const projectId = project.id; // 현재 렌더링 중인 프로젝트 ID 사용

            if (confirm(`프로젝트 상태를 "${status}"로 변경하시겠습니까?`)) {
                updateProjectStatus(projectId, status);
            }
        });

        $('#add-task-btn').off('click').on('click', function() {
            const projectId = $(this).data('project-id');
            openAddTaskModal(projectId);
        });

    }

    // 프로젝트 완료 함수
    function completeProject(projectId) {
        // 로딩 상태 표시
        const originalContent = $('#project-detail-container').html();
        $('#project-detail-container').append(`
        <div class="position-absolute top-50 start-50 translate-middle bg-white p-3 rounded shadow" style="z-index: 1000">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">처리 중...</span>
            </div>
            <p class="mt-2">프로젝트 완료 처리 중...</p>
        </div>
    `);

        $.ajax({
            url: `/api/projects/${projectId}/complete`,
            method: 'PATCH',
            success: function(project) {
                // 모달 내용 업데이트
                renderProjectDetail(project);
                // 프로젝트 카드 업데이트
                updateProjectCard(project);

                alert('프로젝트가 완료 처리되었습니다.');
            },
            error: function(xhr, status, error) {
                // 오류 발생 시 원래 콘텐츠 복원
                $('#project-detail-container').html(originalContent);
                console.error("프로젝트 완료 API 호출 오류:", xhr.responseText);
                alert('프로젝트 완료 처리에 실패했습니다: ' + error);
            }
        });
    }

    // 프로젝트 카드 업데이트 함수
    function updateProjectCard(project) {
        const card = $(`.project-card[data-project-id="${project.id}"]`);

        // 상태 뱃지 업데이트
        let statusClass = '';
        if (project.status === '진행중') {
            statusClass = 'bg-primary';
        } else if (project.status === '완료') {
            statusClass = 'bg-success';
        } else if (project.status === '지연') {
            statusClass = 'bg-danger';
        } else {
            statusClass = 'bg-warning';
        }

        card.find('.card-header .badge')
            .removeClass('bg-success bg-primary bg-warning bg-danger bg-secondary')
            .addClass(statusClass)
            .text(project.status);

        // 진행률에 따른 클래스 설정
        let progressClass = '';
        if (project.progress < 30) {
            progressClass = 'bg-danger';
        } else if (project.progress < 70) {
            progressClass = 'bg-warning';
        } else {
            progressClass = 'bg-success';
        }

        card.find('.progress-bar')
            .removeClass('bg-danger bg-warning bg-success bg-primary')
            .addClass(progressClass)
            .css('width', `${project.progress}%`)
            .attr('aria-valuenow', project.progress)
            .text(`${project.progress}%`);


        // 업무 정보 업데이트
        card.find('small.text-muted').eq(0)
            .html(`<span>${project.taskCount || 0}</span>개 업무 중 <span>${project.completedTaskCount || 0}</span>개 완료`);

        // 프로젝트 날짜 정보 업데이트
        const startDate = project.startDate ? formatDate(new Date(project.startDate)) : '';
        const endDate = project.endDate ? formatDate(new Date(project.endDate)) : '';
        card.find('small.text-muted').eq(1).text(`${startDate} ~ ${endDate}`);
    }

    // 모든 프로젝트 정보 새로고침
    function refreshProjects() {
        $.ajax({
            url: '/api/projects',
            method: 'GET',
            success: function(projects) {
                renderProjects(projects);
            },
            error: function(xhr, status, error) {
                console.error('프로젝트 로드 오류:', error);
                alert('프로젝트 정보를 불러오는데 실패했습니다.');
            }
        });
    }


    // 업무 추가 모달 열기
    function openAddTaskModal(projectId) {
        // 모달 폼 초기화
        $('#add-task-form')[0].reset();

        // 프로젝트 ID 설정
        $('#project-id-for-task').val(projectId);

        // 프로젝트 멤버 목록 로드
        loadProjectMembers(projectId);

        // 오늘 날짜를 기본값으로 설정 (마감일)
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        $('#task-due-date').val(formattedDate);

        // 모달 표시
        $('#addTaskModal').modal('show');
    }

    // 프로젝트 멤버 로드 함수
    function loadProjectMembers(projectId) {
        // 담당자 선택 드롭다운 요소
        const assigneeSelect = $('#task-assignee');

        // 기존 옵션 초기화 (첫 번째 옵션 "담당자 선택"만 남김)
        assigneeSelect.empty();
        assigneeSelect.append('<option value="">담당자 선택</option>');

        // 로딩 표시
        assigneeSelect.prop('disabled', true);
        assigneeSelect.append('<option>멤버 로딩 중...</option>');

        // Ajax 요청으로 프로젝트 멤버 목록 가져오기
        $.ajax({
            url: `/api/projects/${projectId}/members`,
            method: 'GET',
            success: function(members) {
                // 로딩 옵션 제거
                assigneeSelect.empty();
                assigneeSelect.append('<option value="">담당자 선택</option>');

                // 멤버가 없는 경우
                if (!members || members.length === 0) {
                    assigneeSelect.append('<option disabled>프로젝트 멤버가 없습니다</option>');
                    assigneeSelect.prop('disabled', false);
                    return;
                }

                // 멤버 옵션 추가
                members.forEach(member => {
                    assigneeSelect.append(`
                    <option value="${member.empNum}">${member.name} (${member.role || '멤버'})</option>
                `);
                });

                // 현재 사용자를 기본 선택 (가능한 경우)
                // 현재 사용자 정보가 있다면 설정
                if (typeof currentUserEmpNum !== 'undefined' && currentUserEmpNum) {
                    // 현재 사용자가 멤버 목록에 있는지 확인
                    const hasCurrentUser = members.some(member => member.empNum === currentUserEmpNum);
                    if (hasCurrentUser) {
                        assigneeSelect.val(currentUserEmpNum);
                    }
                }

                // 드롭다운 활성화
                assigneeSelect.prop('disabled', false);
            },
            error: function(xhr, status, error) {
                console.error('프로젝트 멤버 로드 오류:', error);

                // 오류 표시
                assigneeSelect.empty();
                assigneeSelect.append('<option value="">담당자 선택</option>');
                assigneeSelect.append('<option disabled>멤버 로드 실패</option>');
                assigneeSelect.prop('disabled', false);
            }
        });
    }

    // 업무 저장 버튼 클릭 이벤트
    $('#save-task-btn').off('click').on('click', function() {
        if (validateTaskForm()) {
            saveTask();
        }
    });

    // 업무 폼 유효성 검사
    function validateTaskForm() {
        const title = $('#task-title').val().trim();
        if (!title) {
            alert('업무 제목을 입력해주세요.');
            return false;
        }

        const assignee = $('#task-assignee').val();
        if (!assignee) {
            alert('담당자를 선택해주세요.');
            return false;
        }

        return true;
    }

    // 업무 저장
    function saveTask() {
        if (!validateTaskForm()) {
            return;
        }

        const task = {
            projectId: $('#project-id-for-task').val(),
            title: $('#task-title').val().trim(),
            description: $('#task-description').val().trim(),
            priority: $('#task-priority').val(),
            dueDate: $('#task-due-date').val() || null,
            assigneeEmpNum: $('#task-assignee').val(),
            status: '미시작',
            progress: 0
        };

        $.ajax({
            url: '/api/tasks',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(task),
            success: function(createdTask) {
                // 모달 닫기
                $('#addTaskModal').modal('hide');

                // 폼 초기화
                $('#add-task-form')[0].reset();

                // 업무 목록 새로고침 (프로젝트 상세 페이지에 있는 경우)
                const projectId = task.projectId;
                loadProjectTasks(projectId);

                alert('업무가 등록되었습니다.');
            },
            error: function(xhr, status, error) {
                alert('업무 등록에 실패했습니다: ' + error);
                console.error('업무 등록 실패:', xhr.responseText);
            }
        });
    }

    // 프로젝트 목록 렌더링
    function renderProjects(projects) {
        const container = $('#project-cards');
        container.empty();

        if (!projects || projects.length === 0) {
            container.html('<div class="col"><p class="text-center">프로젝트가 없습니다.</p></div>');
            return;
        }

        projects.forEach(project => {
            // 진행률 클래스 계산
            let progressClass = '';
            if (project.progress < 30) {
                progressClass = 'bg-danger';
            } else if (project.progress < 70) {
                progressClass = 'bg-warning';
            } else {
                progressClass = 'bg-success';
            }

            // 상태 뱃지 클래스 계산
            let statusClass = '';
            if (project.status === '진행중') {
                statusClass = 'bg-primary';
            } else if (project.status === '완료') {
                statusClass = 'bg-success';
            } else if (project.status === '지연') {
                statusClass = 'bg-danger';
            } else if (project.status === '준비중') {
                statusClass = 'bg-secondary';
            } else {
                statusClass = 'bg-warning';
            }

            const cardHtml = `
        <div class="col">
            <div class="card project-card" data-project-id="${project.id}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>${project.name}</span>
                    <span class="badge ${statusClass}">${project.status}</span>
                </div>
                <div class="card-body">
                    <p class="card-text">${project.description || '설명이 없습니다.'}</p>
                    <div class="progress task-progress">
                        <div class="progress-bar ${progressClass}" role="progressbar"
                             style="width: ${project.progress}%" aria-valuenow="${project.progress}"
                             aria-valuemin="0" aria-valuemax="100">
                            ${project.progress}%
                        </div>
                    </div>
                    <small class="text-muted">
                        ${project.taskCount || 0}개 업무 중 ${project.completedTaskCount || 0}개 완료
                    </small>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">
                            ${formatDate(new Date(project.startDate))} ~ ${formatDate(new Date(project.endDate))}
                        </small>
                        <small class="text-muted">
                            ${project.memberNames && project.memberNames.length > 0 ?
                project.memberNames.join(', ') : '참여자 없음'}
                        </small>
                    </div>
                </div>
            </div>
        </div>
        `;

            container.append(cardHtml);
        });

        // 프로젝트 카드 클릭 이벤트 등록
        initProjectCardEvents();
    }


    // 프로젝트의 업무 목록 불러오기
    function loadProjectTasks(projectId) {
        $('#project-tasks-container').html(`
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">로딩 중...</span>
            </div>
            <p>업무 목록을 불러오는 중입니다...</p>
        </div>
    `);

        $.ajax({
            url: `/api/projects/${projectId}/tasks`,
            method: 'GET',
            success: function(tasks) {
                renderProjectTasks(tasks);
            },
            error: function(xhr, status, error) {
                $('#project-tasks-container').html(`
                <div class="alert alert-danger">
                    <p>업무 목록을 불러오는데 실패했습니다.</p>
                    <p>오류: ${error}</p>
                </div>
            `);
            }
        });
    }

    // 프로젝트 업무 목록 렌더링
    function renderProjectTasks(tasks) {
        if (!tasks || tasks.length === 0) {
            $('#project-tasks-container').html('<p class="text-center">이 프로젝트에 등록된 업무가 없습니다.</p>');
            return;
        }

        let html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>제목</th>
                        <th>담당자</th>
                        <th>상태</th>
                        <th>우선순위</th>
                        <th>진행률</th>
                        <th>마감일</th>
                    </tr>
                </thead>
                <tbody>
    `;

        tasks.forEach(task => {
            // 상태에 따른 뱃지 클래스
            let statusClass = '';
            if (task.status === '미시작') {
                statusClass = 'bg-secondary';
            } else if (task.status === '진행중') {
                statusClass = 'bg-primary';
            } else if (task.status === '완료') {
                statusClass = 'bg-success';
            } else {
                statusClass = 'bg-warning';
            }

            // 우선순위에 따른 뱃지 클래스
            let priorityClass = '';
            if (task.priority === '높음') {
                priorityClass = 'bg-danger';
            } else if (task.priority === '중간') {
                priorityClass = 'bg-warning';
            } else {
                priorityClass = 'bg-info';
            }

            html += `
            <tr class="task-row" data-task-id="${task.id}">
                <td>${task.title}</td>
                <td>${task.assigneeName || '미배정'}</td>
                <td><span class="badge ${statusClass}">${task.status}</span></td>
                <td><span class="badge ${priorityClass}">${task.priority}</span></td>
                <td>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: ${task.progress}%"
                            aria-valuenow="${task.progress}" aria-valuemin="0" aria-valuemax="100">
                            ${task.progress}%
                        </div>
                    </div>
                </td>
                <td>${task.dueDate ? formatDate(new Date(task.dueDate)) : '미정'}</td>
            </tr>
        `;
        });

        html += `
                </tbody>
            </table>
        </div>
    `;

        $('#project-tasks-container').html(html);

        // 업무 행 클릭 이벤트 등록
        $('.task-row').off('click').on('click', function() {
            const taskId = $(this).data('task-id');
            openTaskDetailModal(taskId);
        });
    }

    // 업무 상세 모달 열기 (새 함수)
    function openTaskDetailModal(taskId) {
        // Ajax로 업무 상세 정보 조회
        $.ajax({
            url: `/api/tasks/${taskId}`,
            method: 'GET',
            success: function(task) {
                // 업무 진행도 모달을 재활용하여 상세 정보 표시
                $('#task-progress-modal-title').text(`${task.title} - 진행도 업데이트`);
                $('#task-progress-slider').val(task.progress);
                $('#task-progress-value').text(`${task.progress}%`);
                $('#task-id-for-progress').val(taskId);

                // 모달 표시
                $('#taskProgressModal').modal('show');
            },
            error: function(xhr, status, error) {
                alert('업무 정보를 불러오는데 실패했습니다: ' + error);
            }
        });
    }

    // 프로젝트 상태 변경 함수
    function updateProjectStatus(projectId, status) {
        // 로딩 상태 표시
        const originalContent = $('#project-detail-container').html();
        $('#project-detail-container').append(`
        <div class="position-absolute top-50 start-50 translate-middle bg-white p-3 rounded shadow" style="z-index: 1000">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">변경 중...</span>
            </div>
            <p class="mt-2">상태 변경 중...</p>
        </div>
    `);

        $.ajax({
            url: `/api/projects/${projectId}/status`,
            method: 'PATCH',
            contentType: 'application/json',
            data: JSON.stringify({ status: status }),
            success: function(project) {
                // 모달 내용 업데이트
                renderProjectDetail(project);
                // 프로젝트 카드 업데이트
                updateProjectCard(project);

                alert(`프로젝트 상태가 "${status}"로 변경되었습니다.`);
            },
            error: function(xhr, status, error) {
                // 오류 발생 시 원래 콘텐츠 복원
                $('#project-detail-container').html(originalContent);
                console.error("상태 변경 API 호출 오류:", xhr.responseText);
                alert('프로젝트 상태 변경에 실패했습니다: ' + error);
            }
        });
    }


</script>
<div th:replace="fragments/header :: headerScripts"></div>
<!-- 스타일시트 추가 -->
<th:block th:replace="fragments/sidebar/work-sidebar :: sidebar-styles"></th:block>

<!-- 스크립트 추가 (jQuery 아래에 위치) -->
<th:block th:replace="fragments/sidebar/work-sidebar :: sidebar-scripts"></th:block>
</body>
</html>
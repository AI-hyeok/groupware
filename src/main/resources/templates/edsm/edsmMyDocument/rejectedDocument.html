<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href= "/assets/css/edsm/edsmMain.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>전자결재</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome 아이콘 사용 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- 헤더 에셋 포함 -->
    <th:block th:replace="fragments/header :: headerAssets"></th:block>
    <!-- 사이드바 스타일 포함 -->
    <link rel="stylesheet" th:href="@{/assets/css/fragments/sidebar-common.css}">

    <!-- 날짜 필터 스타일 -->
    <style>
        /* 테이블 헤더 영역 스타일 수정 */
        .table-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px 0;
        }

        .table-header-container h4 {
            margin: 0;
            flex-shrink: 0;
        }

        /* 날짜 필터 컨테이너 스타일 */
        .document-filter-container {
            flex-grow: 1;
            text-align: right;
            padding: 0 10px;
            margin: 0;
        }

        /* 필터 컨테이너 스타일 */
        .date-filter-container {
            position: relative;
            display: inline-block;
        }

        /* 필터 토글 버튼 */
        .filter-toggle-btn {
            padding: 6px 12px;
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            color:#2c5282;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            font-size: 0.9em;
        }

        .filter-toggle-btn:hover {
            background-color: #e9ecef;
        }

        .filter-toggle-btn.active {
            background-color: #4dabf7;
            color: white;
            border-color: #4dabf7;
        }

        .filter-text {
            margin-left: 5px;
        }

        /* 필터 패널 */
        .filter-panel {
            position: absolute;
            right: 0;
            top: 38px;
            width: 320px;
            padding: 15px;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 100;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        /* 애니메이션 */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 날짜 필터 요소 스타일 */
        .date-filter {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .date-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-filter label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 5px;
        }

        .date-filter-start, .date-filter-end {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            flex: 1;
        }

        .filter-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .filter-btn {
            width: 126px;
            height: 40px;
            padding: 8px 15px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }

        .apply-date-filter {
            background-color: #4dabf7;
            color: white;
            flex: 1;
            margin-right: 5px;
        }

        .apply-date-filter:hover {
            background-color: #3a8fd9;
        }

        .reset-date-filter {
            background-color: #6c757d;
            color: white;
            flex: 1;
            margin-left: 5px;
        }

        .reset-date-filter:hover {
            background-color: #5a6268;
        }

        /* 활성화된 필터 표시 */
        .active-filter-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #fa5252;
            color: white;
            width: 18px;
            height: 18px;
            font-size: 0.75em;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* 활성화된 필터 정보 */
        .active-filters {
            margin: 5px 0 0 auto !important;
            padding: 4px 8px !important;
            font-size: 0.85em !important;
            background-color: #e2f0fd;
            border-left: 4px solid #4dabf7;
            border-radius: 2px;
            color: #495057;
            width: fit-content;
        }

        /* 필터링된 결과가 없을 때 메시지 스타일 */
        .no-results-message {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin: 10px 0;
        }

        /* 모바일 대응 */
        @media (max-width: 768px) {
            .table-header-container {
                flex-direction: column;
                align-items: flex-start;
            }

            .document-filter-container {
                margin-top: 10px;
                width: 100%;
                text-align: left;
                padding: 0;
            }

            .filter-panel {
                width: 280px;
                right: -70px;
            }

            .date-inputs {
                flex-direction: column;
                align-items: stretch;
            }

            .date-inputs span {
                text-align: center;
                margin: 5px 0;
            }

            .active-filters {
                margin: 5px 0 0 0 !important;
                width: 100%;
            }
        }
    </style>
</head>
<body>
<!-- 헤더 -->
<div th:replace="fragments/header :: header"></div>

<!-- 좌측 사이드바 -->
<div class="sidebar">
    <button class="create-button" id="create-button">
        <i class="fas fa-plus"></i>
        작성하기
    </button>

    <div class="menu-section">
        <div class="menu-header">
            <i class="fas fa-chevron-down"></i>
            결재 상태
        </div>
        <div class="menu-items">
            <div class="menu-item" id="main">
                <i class="fas fa-folder"></i>
                전체
            </div>
            <div class="menu-item" id="wait">
                <i class="fas fa-spinner"></i>
                대기
            </div>
            <div class="menu-item" id="expected">
                <i class="fas fa-clock"></i>
                예정
            </div>
        </div>
    </div>

    <div class="menu-section">
        <div class="menu-header">
            <i class="fas fa-chevron-down"></i>
            나의 문서함
        </div>
        <div class="menu-items">
            <div class="menu-item" id="myWritten">
                <i class="fas fa-pen"></i>
                기안
            </div>
            <div class="menu-item" id="approval">
                <i class="fas fa-file-signature"></i>
                승인
            </div>
            <div class="menu-item active" id="rejected">
                <i class="fas fa-undo"></i>
                반려
            </div>
        </div>
    </div>
</div>

<!-- 메인 콘텐츠 영역 -->
<div class="main-content">
    <div class="navi-content">
        <span>나의 문서함 (반려)</span>
        <select id="select" align-items="right">
            <option>문서 메뉴 선택</option>
            <option value="나의 결재 상태 (전체)">나의 결재 상태 (전체)</option>
            <option value="결재 대기 문서">결재 대기 문서</option>
            <option value="결재 예정 문서">결재 예정 문서</option>
            <option value="나의 문서함 (전체)">나의 문서함 (전체)</option>
            <option value="나의 문서함 (승인)">나의 문서함 (승인)</option>
            <option value="나의 문서함 (반려)">나의 문서함 (반려)</option>
        </select>
    </div>

    <!-- 상단에 문서 유형 선택 셀렉트 박스 -->
    <div class="document-type-select">
        <label for="docTypeSelect"><i class="fas fa-filter"></i> 문서 유형 필터링:</label>
        <select id="docTypeSelect">
            <option value="all">전체 문서 보기</option>
            <option value="업무연락">업무연락</option>
            <option value="지출결의서">지출결의서</option>
            <option value="품의서">품의서</option>
            <option value="휴가신청서">휴가신청서</option>
            <option value="연장근무신청서">연장근무신청서</option>
        </select>
    </div>

    <!-- 업무연락 문서 목록 -->
    <div class="doc-table-container" data-doc-type="업무연락">
        <h4>업무연락서</h4>
        <table class="document-table">
            <thead>
            <tr>
                <th>문서 번호</th>
                <th>제목</th>
                <th>기안자</th>
                <th>기안일</th>
                <th>구분</th>
                <th>문서 상태</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${#lists.isEmpty(myRejectedDocumentBc)}">
                <td colspan="6" style="text-align:center; padding:20px; color:#999; font-style:italic;">문서가 없습니다.</td>
            </tr>
            <tr th:each="doc : ${myRejectedDocumentBc}">
                <td th:text="${doc.id}"></td>
                <td>
                    <a th:href="@{'/edsmDetail/businessContact/' + ${doc.id}}" th:text="${doc.title}"></a>
                </td>
                <td th:text="${doc.drafterName}"></td>
                <td th:text="${#dates.format(doc.drafterDate, 'yyyy-MM-dd')}"></td>
                <td th:switch="${doc.edsmFormId}">
                    <p th:case="1001">업무연락</p>
                    <p th:case="1002">지출결의</p>
                    <p th:case="1003">품의</p>
                    <p th:case="1004">휴가신청</p>
                    <p th:case="1005">연장근무</p>
                </td>
                <td th:text="${doc.status}"
                    th:style="${(doc.status == '예정') ? 'color:black;'
                    : ((doc.status == '승인') ? 'color:green;'
                    : ((doc.status == '반려') ? 'color:red;'
                    : ((doc.status == '대기') ? 'color:blue;'
                    : '')))}"></td>
            </tr>
            </tbody>
        </table>
        <!-- 페이지네이션 -->
        <div class="pagination"></div>
    </div>

    <!-- 지출결의서 문서 목록 -->
    <div class="doc-table-container" data-doc-type="지출결의서">
        <h4>지출결의서</h4>
        <table class="document-table">
            <thead>
            <tr>
                <th>문서 번호</th>
                <th>제목</th>
                <th>기안자</th>
                <th>기안일</th>
                <th>구분</th>
                <th>문서 상태</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${#lists.isEmpty(myRejectedDocumentCdv)}">
                <td colspan="6" style="text-align:center; padding:20px; color:#999; font-style:italic;">문서가 없습니다.</td>
            </tr>
            <tr th:each="doc : ${myRejectedDocumentCdv}">
                <td th:text="${doc.id}"></td>
                <td>
                    <a th:href="@{'/edsmDetail/cashDisbuVoucher/' + ${doc.id}}" th:text="${doc.title}"></a>
                </td>
                <td th:text="${doc.drafterName}"></td>
                <td th:text="${#dates.format(doc.drafterDate, 'yyyy-MM-dd')}"></td>
                <td th:switch="${doc.edsmFormId}">
                    <p th:case="1001">업무연락</p>
                    <p th:case="1002">지출결의</p>
                    <p th:case="1003">품의</p>
                    <p th:case="1004">휴가신청</p>
                    <p th:case="1005">연장근무</p>
                </td>
                <td th:text="${doc.status}"
                    th:style="${(doc.status == '예정') ? 'color:black;'
                    : ((doc.status == '승인') ? 'color:green;'
                    : ((doc.status == '반려') ? 'color:red;'
                    : ((doc.status == '대기') ? 'color:blue;'
                    : '')))}"></td>
            </tr>
            </tbody>
        </table>
        <!-- 페이지네이션 -->
        <div class="pagination"></div>
    </div>

    <!-- 품의서 결재 상황 -->
    <div class="doc-table-container" data-doc-type="품의서">
        <h4>품의서</h4>
        <table class="document-table">
            <thead>
            <tr>
                <th>문서 번호</th>
                <th>제목</th>
                <th>기안자</th>
                <th>기안일</th>
                <th>구분</th>
                <th>문서 상태</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${#lists.isEmpty(myRejectedDocumentLoa)}">
                <td colspan="6" style="text-align:center; padding:20px; color:#999; font-style:italic;">문서가 없습니다.</td>
            </tr>
            <tr th:each="doc : ${myRejectedDocumentLoa}">
                <td th:text="${doc.id}"></td>
                <td>
                    <a th:href="@{'/edsmDetail/letterOfApproval/' + ${doc.id}}" th:text="${doc.title}"></a>
                </td>
                <td th:text="${doc.drafterName}"></td>
                <td th:text="${#dates.format(doc.drafterDate, 'yyyy-MM-dd')}"></td>
                <td th:switch="${doc.edsmFormId}">
                    <p th:case="1001">업무연락</p>
                    <p th:case="1002">지출결의</p>
                    <p th:case="1003">품의</p>
                    <p th:case="1004">휴가신청</p>
                    <p th:case="1005">연장근무</p>
                </td>
                <td th:text="${doc.status}"
                    th:style="${(doc.status == '예정') ? 'color:black;'
                    : ((doc.status == '승인') ? 'color:green;'
                    : ((doc.status == '반려') ? 'color:red;'
                    : ((doc.status == '대기') ? 'color:blue;'
                    : '')))}"></td>
            </tr>
            </tbody>
        </table>
        <!-- 페이지네이션 -->
        <div class="pagination"></div>
    </div>

    <!-- 휴가신청 결재 상황 -->
    <div class="doc-table-container" data-doc-type="휴가신청서">
        <h4>휴가신청서</h4>
        <table class="document-table">
            <thead>
            <tr>
                <th>문서 번호</th>
                <th>제목</th>
                <th>기안자</th>
                <th>기안일</th>
                <th>구분</th>
                <th>문서 상태</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${#lists.isEmpty(myRejectedDocumentLeaves)}">
                <td colspan="6" style="text-align:center; padding:20px; color:#999; font-style:italic;">문서가 없습니다.</td>
            </tr>
            <tr th:each="doc : ${myRejectedDocumentLeaves}">
                <td th:text="${doc.id}"></td>
                <td>
                    <a th:href="@{'/edsmDetail/leavesDetail/' + ${doc.id}}" th:text="${doc.title}"></a>
                </td>
                <td th:text="${doc.drafterName}"></td>
                <td th:text="${#dates.format(doc.drafterDate, 'yyyy-MM-dd')}"></td>
                <td th:switch="${doc.edsmFormId}">
                    <p th:case="1001">업무연락</p>
                    <p th:case="1002">지출결의</p>
                    <p th:case="1003">품의</p>
                    <p th:case="1004">휴가신청</p>
                    <p th:case="1005">연장근무</p>
                </td>
                <td th:text="${doc.status}"
                    th:style="${(doc.status == '예정') ? 'color:black;'
                    : ((doc.status == '승인') ? 'color:green;'
                    : ((doc.status == '반려') ? 'color:red;'
                    : ((doc.status == '대기') ? 'color:blue;'
                    : '')))}"></td>
            </tr>
            </tbody>
        </table>
        <!-- 페이지네이션 -->
        <div class="pagination"></div>
    </div>

    <!-- 연장근무신청 결재 상황 -->
    <div class="doc-table-container" data-doc-type="연장근무신청서">
        <h4>연장근무신청서</h4>
        <table class="document-table">
            <thead>
            <tr>
                <th>문서 번호</th>
                <th>제목</th>
                <th>기안자</th>
                <th>기안일</th>
                <th>구분</th>
                <th>문서 상태</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${#lists.isEmpty(myRejectedDocumentOvertime)}">
                <td colspan="6" style="text-align:center; padding:20px; color:#999; font-style:italic;">문서가 없습니다.</td>
            </tr>
            <tr th:each="doc : ${myRejectedDocumentOvertime}">
                <td th:text="${doc.id}"></td>
                <td>
                    <a th:href="@{'/edsmDetail/overtimesDetail/' + ${doc.id}}" th:text="${doc.title}"></a>
                </td>
                <td th:text="${doc.drafterName}"></td>
                <td th:text="${#dates.format(doc.drafterDate, 'yyyy-MM-dd')}"></td>
                <td th:switch="${doc.edsmFormId}">
                    <p th:case="1001">업무연락</p>
                    <p th:case="1002">지출결의</p>
                    <p th:case="1003">품의</p>
                    <p th:case="1004">휴가신청</p>
                    <p th:case="1005">연장근무</p>
                </td>
                <td th:text="${doc.status}"
                    th:style="${(doc.status == '예정') ? 'color:black;'
                    : ((doc.status == '승인') ? 'color:green;'
                    : ((doc.status == '반려') ? 'color:red;'
                    : ((doc.status == '대기') ? 'color:blue;'
                    : '')))}"></td>
            </tr>
            </tbody>
        </table>
        <!-- 페이지네이션 -->
        <div class="pagination"></div>
    </div>
</div>

<!-- 헤더 관련 스크립트 포함 -->
<div th:replace="fragments/header :: headerScripts"></div>
<!-- 공통 사이드바 스크립트 포함 -->
<script th:src="@{/assets/js/fragments/sidebar-common.js}"></script>

<script>
    $(document).ready(function() {
        // 네비게이션 클릭 이벤트
        // 작성하기 버튼
        $("#create-button").on("click", function () {
            location.href = "/edsmForm/input";
        });
        // 전체 버튼
        $("#main").on("click", function () {
            location.href = "/edsm/main";
        });
        // 예정 버튼
        $("#expected").on("click", function () {
            location.href = "/edsm/expected";
        });
        // 대기 버튼
        $("#wait").on("click", function () {
            location.href = "/edsm/wait";
        });

        // 나의 문서함
        // 기안 버튼
        $("#myWritten").on("click", function () {
            location.href = "/edsm/myWritten";
        });
        // 승인버튼
        $("#approval").on("click", function () {
            location.href = "/edsm/approval";
        });
        // 반려버튼
        $("#rejected").on("click", function () {
            location.href = "/edsm/rejected";
        });

        // 셀렉트 박스 변경 시 애니메이션과 함께 문서 유형 필터링
        $("#docTypeSelect").on("change", function() {
            let selectedType = $(this).val();

            if(selectedType === "all") {
                $(".doc-table-container").each(function(index) {
                    $(this).fadeIn(300 + (index * 100));
                });
            } else {
                $(".doc-table-container").each(function() {
                    let docType = $(this).data("doc-type");
                    if(docType === selectedType) {
                        $(this).fadeIn(300);
                    } else {
                        $(this).fadeOut(200);
                    }
                });
            }
        });

        // 문서가 없는 테이블에 메시지 표시 함수
        function showEmptyTableMessage() {
            $(".doc-table-container").each(function() {
                let $container = $(this);
                let $table = $container.find("table.document-table");
                let $tbody = $table.find("tbody");
                let visibleRows = $tbody.find("tr:visible").not(".empty-message").length;

                if (visibleRows === 0) {
                    // 이미 메시지가 있는지 확인
                    if ($tbody.find("tr.empty-message").length === 0) {
                        $tbody.append('<tr class="empty-message"><td colspan="6">문서가 없습니다.</td></tr>');
                    } else {
                        $tbody.find("tr.empty-message").show();
                    }
                } else {
                    // 데이터가 있으면 메시지 숨기기
                    $tbody.find("tr.empty-message").hide();
                }
            });
        }

        // 페이지 로드 시 실행
        showEmptyTableMessage();

        // 필터링 시에도 메시지 갱신
        $("#docTypeSelect").on("change", function() {
            // 애니메이션 후 메시지 표시 (타이밍 조정)
            setTimeout(showEmptyTableMessage, 350);
        });

        // 페이지네이션 이벤트 후에도 메시지 확인
        $(".pagination").on("click", "a.page-link", function() {
            setTimeout(showEmptyTableMessage, 300);
        });

        // 페이지 로드 시 문서 컨테이너 순차적으로 표시
        $(".doc-table-container").hide();
        $(".doc-table-container").each(function(index) {
            $(this).delay(index * 150).fadeIn(300);
        });

        // 초기 상태 설정
        $("#docTypeSelect").val("all");

        // 페이지네이션 설정
        const recordsPerPage = 5;
        const naviCountPerPage = 5;

        $(".doc-table-container").each(function(){
            let $container = $(this);
            let $table = $container.find("table.document-table");
            let $rows = $table.find("tbody tr");
            let totalRecords = $rows.length;
            let totalPages = Math.ceil(totalRecords / recordsPerPage);

            // 페이지네이션이 필요한 경우에만 표시
            if(totalRecords > recordsPerPage) {
                let $pagination = $container.find(".pagination");
                if($pagination.length === 0){
                    $pagination = $('<div class="pagination"></div>');
                    $container.append($pagination);
                }

                // 현재 페이지 번호
                let currentPage = 1;

                // 페이지네이션 렌더링 함수
                function renderPagination(page) {
                    currentPage = page;
                    $pagination.empty();

                    // 현재 페이지가 포함되는 그룹 계산
                    let groupIndex = Math.floor((currentPage - 1) / naviCountPerPage);
                    let startPage = groupIndex * naviCountPerPage + 1;
                    let endPage = Math.min(startPage + naviCountPerPage - 1, totalPages);

                    // 이전 그룹 버튼
                    if(startPage > 1) {
                        $pagination.append('<a href="#" class="page-link prev-group" data-page="'+(startPage-1)+'"><i class="fas fa-angle-left"></i></a>');
                    }

                    // 페이지 번호 버튼
                    for(let i = startPage; i <= endPage; i++){
                        $pagination.append('<a href="#" class="page-link" data-page="'+i+'">'+i+'</a>');
                    }

                    // 다음 그룹 버튼
                    if(endPage < totalPages) {
                        $pagination.append('<a href="#" class="page-link next-group" data-page="'+(endPage+1)+'"><i class="fas fa-angle-right"></i></a>');
                    }

                    // 현재 페이지 버튼 활성화
                    $pagination.find("a.page-link").removeClass("active");
                    $pagination.find('a.page-link[data-page="'+currentPage+'"]').addClass("active");
                }

                // 페이지 표시 함수
                function showPage(page) {
                    let start = (page - 1) * recordsPerPage;
                    let end = start + recordsPerPage;
                    $rows.hide();
                    $rows.slice(start, end).show();
                }

                // 초기 페이지 렌더링
                renderPagination(1);
                showPage(1);

                // 페이지네이션 클릭 이벤트
                $pagination.on("click", "a.page-link", function(e){
                    e.preventDefault();
                    let targetPage = $(this).data("page");
                    renderPagination(targetPage);
                    showPage(targetPage);

                    // 해당 컨테이너로 부드럽게 스크롤
                    $('html, body').animate({
                        scrollTop: $container.offset().top - 100
                    }, 300);
                });
            } else {
                // 페이지네이션이 필요 없는 경우 (적은 레코드 수)
                $rows.show();
                $container.find(".pagination").hide();
            }
        });

        // 테이블 행 클릭 이벤트 (제목 링크 외에도 행 전체 클릭 가능)
        $(".document-table tbody tr").on("click", function(e) {
            // 링크가 아닌 부분 클릭 시에만 작동
            if (!$(e.target).is('a')) {
                let link = $(this).find('a').attr('href');
                if (link) {
                    window.location.href = link;
                }
            }
        });

        // select 요소에 변경 이벤트 추가
        $("#select").on("change", function() {
            const selectedValue = $(this).val();

            // 선택된 옵션에 따라 다른 페이지로 이동
            switch(selectedValue) {
                case "나의 결재 상태 (전체)":
                    location.href = "/edsm/main";
                    break;
                case "결재 대기 문서":
                    location.href = "/edsm/wait";
                    break;
                case "결재 예정 문서":
                    location.href = "/edsm/expected";
                    break;
                case "나의 문서함 (전체)":
                    location.href = "/edsm/myWritten";
                    break;
                case "나의 문서함 (승인)":
                    location.href = "/edsm/approval";
                    break;
                case "나의 문서함 (반려)":
                    location.href = "/edsm/rejected";
                    break;
            }
        });

        // 날짜 필터 토글 템플릿
        const dateFilterToggleTemplate = `
        <div class="date-filter-container">
            <button class="filter-toggle-btn">
                <i class="fas fa-filter"></i>
                <span class="filter-text">날짜 필터</span>
            </button>
            <div class="filter-panel">
                <div class="date-filter" data-filter-for="{docType}">
                    <label><i class="fas fa-calendar-alt"></i> 기간 선택</label>
                    <div class="date-inputs">
                        <input type="date" class="date-filter-start" placeholder="시작일">
                        <span>~</span>
                        <input type="date" class="date-filter-end" placeholder="종료일">
                    </div>
                    <div class="filter-actions">
                        <button class="apply-date-filter filter-btn">
                            <i class="fas fa-search"></i> 적용
                        </button>
                        <button class="reset-date-filter filter-btn">
                            <i class="fas fa-undo"></i> 초기화
                        </button>
                    </div>
                </div>
            </div>
        </div>`;

        // 페이지 로드 완료 후 필터 컴포넌트를 각 테이블 제목 옆으로 이동시키는 함수
        function setupTableHeadersWithFilters() {
            // 각 테이블 컨테이너에 필터 추가
            $(".doc-table-container").each(function() {
                const $container = $(this);
                const docType = $container.data("doc-type");

                // 제목(h4)을 찾아서 컨테이너로 감싸기
                const $heading = $container.find("h4").first();
                if ($heading.length) {
                    // h4를 컨테이너로 감싸기 (이미 감싸져 있지 않은 경우)
                    if (!$heading.parent().hasClass("table-header-container")) {
                        $heading.wrap('<div class="table-header-container"></div>');
                    }

                    // 새 컨테이너 참조
                    const $headerContainer = $heading.parent();

                    // 기존 필터를 제거 (이중 추가 방지)
                    $headerContainer.find(".document-filter-container").remove();

                    // 템플릿에서 필터 생성
                    const filterHtml = dateFilterToggleTemplate.replace('{docType}', docType);

                    // 필터 컨테이너 생성 및 추가
                    const $filterContainer = $('<div class="document-filter-container"></div>')
                        .attr('data-filter-for', docType)
                        .html(filterHtml);

                    // 헤더 컨테이너에 필터 추가
                    $headerContainer.append($filterContainer);
                }
            });

            // 필터 이벤트 바인딩
            bindFilterEvents();
        }

        // 필터 이벤트 바인딩 함수
        function bindFilterEvents() {
            // 필터 패널 토글
            $(document).on('click', '.filter-toggle-btn', function(e) {
                e.stopPropagation();
                const $panel = $(this).siblings('.filter-panel');

                if ($panel.is(':visible')) {
                    $panel.fadeOut(200);
                    $(this).removeClass('active');
                } else {
                    // 다른 열린 패널 닫기
                    $('.filter-panel').fadeOut(200);
                    $('.filter-toggle-btn').removeClass('active');

                    // 현재 패널 열기
                    $panel.fadeIn(200);
                    $(this).addClass('active');
                }
            });

            // 패널 외부 클릭 시 패널 닫기
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.date-filter-container').length) {
                    $('.filter-panel').fadeOut(200);
                    $('.filter-toggle-btn').removeClass('active');
                }
            });

            // 각 테이블별 날짜 필터링 기능
            $(document).on("click", ".apply-date-filter", function() {
                const $filterContainer = $(this).closest(".date-filter-container");
                const $dateFilter = $(this).closest(".date-filter");
                const docType = $dateFilter.data("filter-for");
                const $targetContainer = $(".doc-table-container[data-doc-type='" + docType + "']");
                const $toggleBtn = $filterContainer.find('.filter-toggle-btn');

                // 날짜 필터 적용
                applyDateFilters($dateFilter, $targetContainer);

                // 필터 패널 닫기
                $filterContainer.find('.filter-panel').fadeOut(200);
            });

            // 날짜 필터 초기화
            $(document).on("click", ".reset-date-filter", function() {
                const $filterContainer = $(this).closest(".date-filter-container");
                const $dateFilter = $(this).closest(".date-filter");
                const docType = $dateFilter.data("filter-for");
                const $targetContainer = $(".doc-table-container[data-doc-type='" + docType + "']");
                const $toggleBtn = $filterContainer.find('.filter-toggle-btn');

                // 필터 초기화
                resetDateFilters($dateFilter, $targetContainer);

                // 필터 패널 닫기
                $filterContainer.find('.filter-panel').fadeOut(200);
                $toggleBtn.removeClass('active');
            });

            // 엔터 키 이벤트
            $(document).on("keypress", ".date-filter-start, .date-filter-end", function(e) {
                if (e.which === 13) { // Enter key
                    const $filterContainer = $(this).closest(".date-filter-container");
                    const $dateFilter = $(this).closest(".date-filter");
                    const docType = $dateFilter.data("filter-for");
                    const $targetContainer = $(".doc-table-container[data-doc-type='" + docType + "']");

                    // 날짜 필터 적용
                    applyDateFilters($dateFilter, $targetContainer);

                    // 필터 패널 닫기
                    $filterContainer.find('.filter-panel').fadeOut(200);
                    e.preventDefault();
                }
            });
        }

        // 날짜 필터 적용 함수
        function applyDateFilters($dateFilter, $targetContainer) {
            const startDate = $dateFilter.find(".date-filter-start").val();
            const endDate = $dateFilter.find(".date-filter-end").val();
            const $filterContainer = $dateFilter.closest(".date-filter-container");
            const $toggleBtn = $filterContainer.find('.filter-toggle-btn');

            // 날짜 유효성 검사
            if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                alert("시작일은 종료일보다 앞선 날짜여야 합니다.");
                return;
            }

            const $table = $targetContainer.find("table.document-table");
            const $rows = $table.find("tbody tr").not(".empty-message");

            let visibleRowCount = 0;

            // 모든 행 숨기기
            $rows.hide();

            // 각 행 검사
            $rows.each(function() {
                const $row = $(this);
                const dateCell = $row.find("td:nth-child(4)").text().trim(); // 기안일 열

                if (!dateCell) return true; // 날짜 셀 없으면 건너뛰기

                try {
                    const rowDate = new Date(dateCell);
                    const startDateObj = startDate ? new Date(startDate) : null;
                    const endDateObj = endDate ? new Date(endDate) : null;

                    // 날짜 범위 검사
                    let dateMatch = true;

                    if (startDateObj && endDateObj) {
                        // 시작일과 종료일 둘 다 있는 경우
                        // 시간 정보를 제거하고 날짜만 비교하기 위해 날짜 재설정
                        startDateObj.setHours(0, 0, 0, 0);
                        endDateObj.setHours(23, 59, 59, 999);
                        rowDate.setHours(12, 0, 0, 0); // 정오로 설정하여 날짜 비교 오류 방지

                        dateMatch = rowDate >= startDateObj && rowDate <= endDateObj;
                    } else if (startDateObj) {
                        // 시작일만 있는 경우
                        startDateObj.setHours(0, 0, 0, 0);
                        rowDate.setHours(12, 0, 0, 0);
                        dateMatch = rowDate >= startDateObj;
                    } else if (endDateObj) {
                        // 종료일만 있는 경우
                        endDateObj.setHours(23, 59, 59, 999);
                        rowDate.setHours(12, 0, 0, 0);
                        dateMatch = rowDate <= endDateObj;
                    }

                    // 필터 조건에 맞으면 표시
                    if (dateMatch) {
                        $row.show();
                        visibleRowCount++;
                    }
                } catch (e) {
                    // 날짜 파싱 오류 시 해당 행은 숨김 상태 유지
                    console.warn("날짜 파싱 오류:", e, "날짜:", dateCell);
                }
            });

            // 필터링 결과 없음 메시지 처리
            const $emptyMessage = $table.find("tr.empty-message");
            if (visibleRowCount === 0) {
                if ($emptyMessage.length === 0) {
                    $table.find("tbody").append('<tr class="empty-message"><td colspan="6" style="text-align:center; padding:20px; color:#6c757d; font-style:italic;">검색 결과가 없습니다.</td></tr>');
                } else {
                    $emptyMessage.show().find("td").text("검색 결과가 없습니다.");
                }
            } else {
                $emptyMessage.hide();
            }

            // 페이지네이션 업데이트
            updatePagination($targetContainer);

            // 필터가 적용되었음을 시각적으로 표시
            if (startDate || endDate) {
                // 이미 있는 뱃지 제거
                $toggleBtn.find('.active-filter-badge').remove();

                // 새 뱃지 추가
                $toggleBtn.append('<span class="active-filter-badge">✓</span>');
                $toggleBtn.addClass('active');

                // 필터 관련 정보 표시
                displayActiveFilters($filterContainer, startDate, endDate);
            } else {
                resetDateFilters($dateFilter, $targetContainer);
            }
        }

        // 날짜 필터 초기화 함수
        function resetDateFilters($dateFilter, $targetContainer) {
            const $filterContainer = $dateFilter.closest(".date-filter-container");
            const $toggleBtn = $filterContainer.find('.filter-toggle-btn');

            // 입력 필드 초기화
            $dateFilter.find(".date-filter-start, .date-filter-end").val("");

            const $table = $targetContainer.find("table.document-table");
            const $rows = $table.find("tbody tr").not(".empty-message");

            // 모든 행 다시 표시
            $rows.show();

            // 빈 결과 메시지 제거
            $table.find("tr.empty-message").hide();

            // 페이지네이션 재설정
            updatePagination($targetContainer);

            // 필터 시각적 표시 제거
            $toggleBtn.find('.active-filter-badge').remove();
            $toggleBtn.removeClass('active');
            $filterContainer.find(".active-filters").remove();
        }

        // 페이지네이션 업데이트 함수
        function updatePagination($container) {
            const recordsPerPage = 5;
            const naviCountPerPage = 5;

            const $table = $container.find("table.document-table");
            const $rows = $table.find("tbody tr:visible").not(".empty-message");
            const totalRecords = $rows.length;
            const totalPages = Math.ceil(totalRecords / recordsPerPage);

            // 페이지네이션 컨테이너
            let $pagination = $container.find(".pagination");

            // 페이지네이션 필요 여부 확인
            if (totalRecords > recordsPerPage) {
                if ($pagination.length === 0) {
                    $pagination = $('<div class="pagination"></div>');
                    $container.append($pagination);
                }

                // 현재 페이지 번호 (필터링 후에는 첫 페이지로)
                let currentPage = 1;

                // 페이지네이션 렌더링
                renderPagination($pagination, currentPage, totalPages, naviCountPerPage);

                // 첫 페이지 표시
                showPageContent($rows, currentPage, recordsPerPage);

                // 페이지네이션 이벤트 재설정
                $pagination.off("click").on("click", "a.page-link", function(e) {
                    e.preventDefault();
                    const targetPage = $(this).data("page");
                    renderPagination($pagination, targetPage, totalPages, naviCountPerPage);
                    showPageContent($rows, targetPage, recordsPerPage);

                    // 스크롤 처리
                    $('html, body').animate({
                        scrollTop: $container.offset().top - 100
                    }, 300);
                });

                // 페이지네이션 표시
                $pagination.show();
            } else {
                // 페이지네이션 불필요
                $rows.show();
                $pagination.hide();
            }
        }

        // 페이지네이션 렌더링 함수
        function renderPagination($pagination, currentPage, totalPages, naviCountPerPage) {
            $pagination.empty();

            // 페이지 그룹 계산
            const groupIndex = Math.floor((currentPage - 1) / naviCountPerPage);
            const startPage = groupIndex * naviCountPerPage + 1;
            const endPage = Math.min(startPage + naviCountPerPage - 1, totalPages);

            // 이전 그룹 버튼
            if (startPage > 1) {
                $pagination.append('<a href="#" class="page-link prev-group" data-page="' + (startPage - 1) + '"><i class="fas fa-angle-left"></i></a>');
            }

            // 페이지 번호 버튼
            for (let i = startPage; i <= endPage; i++) {
                $pagination.append('<a href="#" class="page-link" data-page="' + i + '">' + i + '</a>');
            }

            // 다음 그룹 버튼
            if (endPage < totalPages) {
                $pagination.append('<a href="#" class="page-link next-group" data-page="' + (endPage + 1) + '"><i class="fas fa-angle-right"></i></a>');
            }

            // 현재 페이지 버튼 활성화
            $pagination.find("a.page-link").removeClass("active");
            $pagination.find('a.page-link[data-page="' + currentPage + '"]').addClass("active");
        }

        // 페이지 내용 표시 함수
        function showPageContent($rows, page, recordsPerPage) {
            const start = (page - 1) * recordsPerPage;
            const end = start + recordsPerPage;

            $rows.hide();
            $rows.slice(start, end).show();
        }

        // 활성화된 필터 표시 함수
        function displayActiveFilters($filterContainer, startDate, endDate) {
            // 기존 필터 표시 제거
            $filterContainer.find(".active-filters").remove();

            if (!startDate && !endDate) return;

            // 날짜 형식 변환 함수
            function formatDate(dateStr) {
                if (!dateStr) return "";
                const date = new Date(dateStr);
                return date.getFullYear() + '-' +
                    String(date.getMonth() + 1).padStart(2, '0') + '-' +
                    String(date.getDate()).padStart(2, '0');
            }

            // 필터 정보 텍스트
            let filterText = '적용된 날짜 필터: ';

            if (startDate && endDate) {
                filterText += formatDate(startDate) + ' ~ ' + formatDate(endDate);
            } else if (startDate) {
                filterText += formatDate(startDate) + ' 이후';
            } else if (endDate) {
                filterText += formatDate(endDate) + ' 이전';
            }

            // 필터 정보 표시 요소 추가
            const $filterInfo = $('<div class="active-filters">' + filterText + '</div>');

            // 필터 정보 DOM에 추가
            $filterContainer.append($filterInfo);
        }

        // 페이지 로드 시 필터 컴포넌트 위치 조정
        setupTableHeadersWithFilters();
    });
</script>

</body>
</html>